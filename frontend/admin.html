<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Admin dashboard for Niche Collector Connector - manage users, posts, and content.">
  <meta name="robots" content="noindex, nofollow">
  <title>Admin Dashboard | Niche Collector Connector</title>

  <!-- Canonical URL -->
  <link rel="canonical" href="https://niche-collector.pages.dev/admin.html">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/admin.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Admin Dashboard</h1>
      <div>
        <a href="/profile.html" class="back-link">Back to Profile</a>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="showTab('users', this)">Users</button>
      <button class="tab-btn" onclick="showTab('posts', this)">Posts</button>
      <button class="tab-btn" onclick="showTab('comments', this)">Comments</button>
      <button class="tab-btn" onclick="showTab('reports', this)">Reports <span class="report-badge" id="pending-reports-badge"></span></button>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content active">
      <!-- Analytics Dashboard -->
      <div class="stats" id="analytics-stats">
        <div class="stat">
          <div class="stat-value" id="total-users">-</div>
          <div class="stat-label">Total Users</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="users-7d">-</div>
          <div class="stat-label">New (7 days)</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="total-collections">-</div>
          <div class="stat-label">Collection Items</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="total-posts">-</div>
          <div class="stat-label">Forum Posts</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="posts-7d">-</div>
          <div class="stat-label">Posts (7 days)</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="avg-collection">-</div>
          <div class="stat-label">Avg Items/User</div>
        </div>
      </div>

      <!-- Top Categories -->
      <div class="stats mb-24" id="categories-stats">
        <div class="w-100">
          <h3 class="section-title">Top Categories</h3>
          <div id="top-categories" class="categories-container">
            <span class="text-muted">Loading...</span>
          </div>
        </div>
      </div>

      <div class="mb-16">
        <button class="export-btn" onclick="exportCSV()">Export Users CSV</button>
      </div>

      <div class="user-table" id="user-table">
        <div class="loading">Loading users...</div>
      </div>
    </div>

    <!-- Posts Tab -->
    <div id="posts-tab" class="tab-content">
      <div class="user-table" id="posts-table">
        <div class="loading">Loading posts...</div>
      </div>
    </div>

    <!-- Comments Tab -->
    <div id="comments-tab" class="tab-content">
      <div class="user-table" id="comments-table">
        <div class="loading">Loading comments...</div>
      </div>
    </div>

    <!-- Reports Tab -->
    <div id="reports-tab" class="tab-content">
      <div class="reports-filters mb-16">
        <select id="report-status-filter" class="filter-select" onchange="loadReports()">
          <option value="">All statuses</option>
          <option value="pending" selected>Pending</option>
          <option value="reviewed">Reviewed</option>
          <option value="actioned">Actioned</option>
          <option value="dismissed">Dismissed</option>
        </select>
        <select id="report-type-filter" class="filter-select" onchange="loadReports()">
          <option value="">All types</option>
          <option value="post">Posts</option>
          <option value="comment">Comments</option>
          <option value="profile">Profiles</option>
          <option value="message">Messages</option>
        </select>
      </div>
      <div class="user-table" id="reports-table">
        <div class="loading">Loading reports...</div>
      </div>
    </div>

    <!-- Moderation Action Modal -->
    <div class="modal" id="mod-action-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Take Moderation Action</h3>
          <button class="modal-close" onclick="closeModActionModal()">&times;</button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="mod-report-id">
          <input type="hidden" id="mod-target-user-id">
          <div class="mod-target-info" id="mod-target-info"></div>
          <div class="form-group">
            <label for="mod-action-type">Action</label>
            <select id="mod-action-type" required>
              <option value="">Select action...</option>
              <option value="warn">Warn user</option>
              <option value="hide">Hide content</option>
              <option value="delete">Delete content</option>
              <option value="suspend">Suspend user</option>
              <option value="ban">Ban user</option>
            </select>
          </div>
          <div class="form-group">
            <label for="mod-action-reason">Reason</label>
            <textarea id="mod-action-reason" rows="3" required placeholder="Explain the reason for this action..."></textarea>
          </div>
          <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModActionModal()">Cancel</button>
            <button class="btn-danger" onclick="submitModAction()">Take Action</button>
          </div>
        </div>
      </div>
    </div>

    <!-- User History Modal -->
    <div class="modal" id="user-history-modal">
      <div class="modal-content modal-lg">
        <div class="modal-header">
          <h3>User Moderation History</h3>
          <button class="modal-close" onclick="closeUserHistoryModal()">&times;</button>
        </div>
        <div class="modal-body" id="user-history-content">
          <div class="loading">Loading history...</div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/config.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    let usersData = [];
    let postsData = [];
    let commentsData = [];

    function showTab(tabName, clickedBtn) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      if (clickedBtn) clickedBtn.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`${tabName}-tab`).classList.add('active');

      // Load data if needed
      if (tabName === 'posts' && postsData.length === 0) {
        loadPosts();
      } else if (tabName === 'comments' && commentsData.length === 0) {
        loadComments();
      } else if (tabName === 'reports' && reportsData.length === 0) {
        loadReports();
      }
    }

    async function loadUsers() {
      const tableEl = document.getElementById('user-table');

      // Check auth
      Auth.init();
      if (!Auth.isAuthenticated()) {
        window.location.href = '/';
        return;
      }

      try {
        const response = await Auth.apiRequest('/api/admin/users');

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          const errorMsg = errorData.detail || 'Access denied';
          tableEl.innerHTML = `<div class="error">${escapeHtml(errorMsg)}</div>`;
          return;
        }

        const data = await response.json();
        usersData = data.users;

        // Update stats
        document.getElementById('total-users').textContent = data.total;

        // Render table
        tableEl.innerHTML = `
          <table>
            <thead>
              <tr>
                <th style="width: 40px;"></th>
                <th>ID</th>
                <th>User</th>
                <th>Email</th>
                <th>Joined</th>
              </tr>
            </thead>
            <tbody>
              ${data.users.map(user => `
                <tr class="user-main-row" data-user-id="${user.id}">
                  <td>
                    <button class="expand-btn" onclick="toggleMemberships(${user.id}, this)" title="Show groups">â–¼</button>
                  </td>
                  <td class="user-id">${user.id}</td>
                  <td>
                    <div class="user-row">
                      <img src="${getSafeImageUrl(user.picture)}"
                           alt=""
                           class="user-avatar"
                           onerror="this.style.display='none'">
                      <span class="user-name">${escapeHtml(user.name || 'No name')}</span>
                    </div>
                  </td>
                  <td class="user-email">${escapeHtml(user.email || '-')}</td>
                  <td class="user-date">${formatDate(user.created_at)}</td>
                </tr>
                <tr class="memberships-row" id="memberships-row-${user.id}">
                  <td colspan="5">
                    <div class="memberships-content" id="memberships-content-${user.id}">
                      <span class="loading-memberships">Loading...</span>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

      } catch (error) {
        console.error('Error loading users:', error);
        tableEl.innerHTML = '<div class="error">Failed to load users. Make sure you have admin access.</div>';
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Escape for use in JavaScript string contexts (onclick handlers, etc.)
    function escapeJsString(text) {
      if (!text) return '';
      return String(text)
        .replace(/\\/g, '\\\\')
        .replace(/'/g, "\\'")
        .replace(/"/g, '\\"')
        .replace(/\n/g, '\\n')
        .replace(/\r/g, '\\r');
    }

    // Validate URL for image sources - only allow safe protocols
    function isValidImageUrl(url) {
      if (!url) return false;
      try {
        const parsed = new URL(url);
        return ['http:', 'https:', 'data:'].includes(parsed.protocol);
      } catch {
        return false;
      }
    }

    function getSafeImageUrl(url) {
      return isValidImageUrl(url) ? url : '';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr.replace(' ', 'T') + 'Z');
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function exportCSV() {
      if (usersData.length === 0) {
        alert('No data to export');
        return;
      }

      const headers = ['ID', 'Name', 'Email', 'Joined'];
      const rows = usersData.map(u => [
        u.id,
        (u.name || '').replace(/,/g, ' '),
        (u.email || '').replace(/,/g, ' '),
        u.created_at || ''
      ]);

      let csv = headers.join(',') + '\n';
      csv += rows.map(r => r.join(',')).join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ncc-users-' + new Date().toISOString().slice(0, 10) + '.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function loadAnalytics() {
      try {
        const response = await Auth.apiRequest('/api/admin/analytics');

        if (!response.ok) {
          console.error('Failed to load analytics');
          return;
        }

        const data = await response.json();

        // Update stats
        document.getElementById('total-users').textContent = data.total_users;
        document.getElementById('users-7d').textContent = data.users_last_7_days;
        document.getElementById('total-collections').textContent = data.total_collections;
        document.getElementById('total-posts').textContent = data.total_posts;
        document.getElementById('posts-7d').textContent = data.posts_last_7_days;
        document.getElementById('avg-collection').textContent = data.collection_stats?.avg_per_user || 0;

        // Update top categories
        const categoriesEl = document.getElementById('top-categories');
        if (data.top_categories && data.top_categories.length > 0) {
          categoriesEl.innerHTML = data.top_categories.map(cat => `
            <div style="text-align: center;">
              <div style="font-size: 1.5rem; font-weight: 600; color: #1db954;">${cat.count}</div>
              <div style="color: rgba(255,255,255,0.6); font-size: 0.8rem;">${escapeHtml(cat.name)}</div>
            </div>
          `).join('');
        } else {
          categoriesEl.innerHTML = '<span style="color: rgba(255,255,255,0.5);">No categories yet</span>';
        }

      } catch (error) {
        console.error('Error loading analytics:', error);
      }
    }

    async function loadPosts() {
      const tableEl = document.getElementById('posts-table');

      try {
        const response = await Auth.apiRequest('/api/admin/posts?limit=50');

        if (!response.ok) {
          tableEl.innerHTML = '<div class="error">Failed to load posts</div>';
          return;
        }

        const data = await response.json();
        postsData = data.posts;

        if (data.posts.length === 0) {
          tableEl.innerHTML = '<div class="loading">No posts yet</div>';
          return;
        }

        tableEl.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Author</th>
                <th>Category</th>
                <th>Votes</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${data.posts.map(post => `
                <tr id="post-row-${post.id}">
                  <td class="user-id">${post.id}</td>
                  <td>
                    <div class="post-title">${escapeHtml(post.title)}</div>
                    <div class="post-body">${escapeHtml(post.body)}</div>
                  </td>
                  <td>
                    <div class="user-name">${escapeHtml(post.author?.name || 'Unknown')}</div>
                    <div class="user-email">${escapeHtml(post.author?.email || '-')}</div>
                  </td>
                  <td>${escapeHtml(post.category_name || '-')}</td>
                  <td>+${post.upvote_count} / -${post.downvote_count}</td>
                  <td>
                    ${post.is_pinned ? '<span class="badge pinned">Pinned</span>' : ''}
                    ${post.is_locked ? '<span class="badge locked">Locked</span>' : ''}
                  </td>
                  <td>
                    <button class="action-btn ${post.is_pinned ? 'active' : ''}" onclick="togglePin(${post.id})">Pin</button>
                    <button class="action-btn ${post.is_locked ? 'active' : ''}" onclick="toggleLock(${post.id})">Lock</button>
                    <button class="action-btn delete" onclick="deletePost(${post.id})">Delete</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

      } catch (error) {
        console.error('Error loading posts:', error);
        tableEl.innerHTML = '<div class="error">Failed to load posts</div>';
      }
    }

    async function loadComments() {
      const tableEl = document.getElementById('comments-table');

      try {
        const response = await Auth.apiRequest('/api/admin/comments?limit=50');

        if (!response.ok) {
          tableEl.innerHTML = '<div class="error">Failed to load comments</div>';
          return;
        }

        const data = await response.json();
        commentsData = data.comments;

        if (data.comments.length === 0) {
          tableEl.innerHTML = '<div class="loading">No comments yet</div>';
          return;
        }

        tableEl.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Comment</th>
                <th>Author</th>
                <th>Post</th>
                <th>Votes</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${data.comments.map(comment => `
                <tr id="comment-row-${comment.id}">
                  <td class="user-id">${comment.id}</td>
                  <td>
                    <div class="post-body" style="max-width: 300px;">${escapeHtml(comment.body)}</div>
                  </td>
                  <td>
                    <div class="user-name">${escapeHtml(comment.author?.name || 'Unknown')}</div>
                    <div class="user-email">${escapeHtml(comment.author?.email || '-')}</div>
                  </td>
                  <td>
                    <div class="post-title" style="max-width: 150px;">${escapeHtml(comment.post_title)}</div>
                  </td>
                  <td>+${comment.upvote_count} / -${comment.downvote_count}</td>
                  <td class="user-date">${formatDate(comment.created_at)}</td>
                  <td>
                    <button class="action-btn delete" onclick="deleteComment(${comment.id})">Delete</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

      } catch (error) {
        console.error('Error loading comments:', error);
        tableEl.innerHTML = '<div class="error">Failed to load comments</div>';
      }
    }

    async function togglePin(postId) {
      try {
        const response = await Auth.apiRequest(`/api/admin/posts/${postId}/pin`, { method: 'PUT' });
        if (response.ok) {
          const data = await response.json();
          // Reload posts to refresh state
          postsData = [];
          loadPosts();
        }
      } catch (error) {
        console.error('Error toggling pin:', error);
        alert('Failed to toggle pin status');
      }
    }

    async function toggleLock(postId) {
      try {
        const response = await Auth.apiRequest(`/api/admin/posts/${postId}/lock`, { method: 'PUT' });
        if (response.ok) {
          const data = await response.json();
          // Reload posts to refresh state
          postsData = [];
          loadPosts();
        }
      } catch (error) {
        console.error('Error toggling lock:', error);
        alert('Failed to toggle lock status');
      }
    }

    async function deletePost(postId) {
      try {
        const response = await Auth.apiRequest(`/api/admin/posts/${postId}`, { method: 'DELETE' });
        if (response.ok) {
          // Remove row from table
          const row = document.getElementById(`post-row-${postId}`);
          if (row) row.remove();
          postsData = postsData.filter(p => p.id !== postId);
        } else {
          alert('Failed to delete post');
        }
      } catch (error) {
        console.error('Error deleting post:', error);
        alert('Failed to delete post');
      }
    }

    async function deleteComment(commentId) {
      try {
        const response = await Auth.apiRequest(`/api/admin/comments/${commentId}`, { method: 'DELETE' });
        if (response.ok) {
          // Remove row from table
          const row = document.getElementById(`comment-row-${commentId}`);
          if (row) row.remove();
          commentsData = commentsData.filter(c => c.id !== commentId);
        } else {
          alert('Failed to delete comment');
        }
      } catch (error) {
        console.error('Error deleting comment:', error);
        alert('Failed to delete comment');
      }
    }

    // Cache for loaded memberships
    const membershipsCache = {};

    async function toggleMemberships(userId, btn) {
      const row = document.getElementById(`memberships-row-${userId}`);
      const content = document.getElementById(`memberships-content-${userId}`);
      const isExpanded = row.classList.contains('show');

      if (isExpanded) {
        // Collapse
        row.classList.remove('show');
        btn.classList.remove('expanded');
        btn.textContent = 'â–¼';
        return;
      }

      // Expand
      row.classList.add('show');
      btn.classList.add('expanded');
      btn.textContent = 'â–²';

      // Check cache
      if (membershipsCache[userId]) {
        renderMemberships(userId, membershipsCache[userId]);
        return;
      }

      // Fetch memberships
      try {
        const response = await Auth.apiRequest(`/api/admin/users/${userId}/memberships`);
        if (response.ok) {
          const data = await response.json();
          membershipsCache[userId] = data.memberships;
          renderMemberships(userId, data.memberships);
        } else {
          content.innerHTML = '<span class="no-memberships">Failed to load</span>';
        }
      } catch (error) {
        console.error('Error loading memberships:', error);
        content.innerHTML = '<span class="no-memberships">Failed to load</span>';
      }
    }

    function renderMemberships(userId, memberships) {
      const content = document.getElementById(`memberships-content-${userId}`);

      if (!memberships || memberships.length === 0) {
        content.innerHTML = '<span class="no-memberships">No group memberships</span>';
        return;
      }

      // Group by category
      const byCategory = {};
      memberships.forEach(m => {
        const catKey = m.category_id || 'unknown';
        if (!byCategory[catKey]) {
          byCategory[catKey] = {
            name: m.category_name || 'Unknown',
            icon: m.category_icon || 'ðŸ“',
            groups: []
          };
        }
        if (m.group_name) {
          byCategory[catKey].groups.push(m.group_name);
        }
      });

      let html = '';
      Object.values(byCategory).forEach(cat => {
        if (cat.groups.length > 0) {
          // Category with groups
          cat.groups.forEach(groupName => {
            html += `
              <div class="membership-tag">
                <span class="icon">${escapeHtml(cat.icon)}</span>
                <span class="category-name">${escapeHtml(cat.name)}</span>
                <span class="separator">â€º</span>
                <span class="group-name">${escapeHtml(groupName)}</span>
              </div>
            `;
          });
        } else {
          // Just category membership (no specific group)
          html += `
            <div class="membership-tag">
              <span class="icon">${escapeHtml(cat.icon)}</span>
              <span class="category-name">${escapeHtml(cat.name)}</span>
            </div>
          `;
        }
      });

      content.innerHTML = html;
    }

    // =============================================================================
    // Reports Functions
    // =============================================================================

    let reportsData = [];

    async function loadReports() {
      const tableEl = document.getElementById('reports-table');
      const statusFilter = document.getElementById('report-status-filter').value;
      const typeFilter = document.getElementById('report-type-filter').value;

      tableEl.innerHTML = '<div class="loading">Loading reports...</div>';

      try {
        let url = '/api/reports/admin?limit=50';
        if (statusFilter) url += `&status=${statusFilter}`;
        if (typeFilter) url += `&content_type=${typeFilter}`;

        const response = await Auth.apiRequest(url);

        if (!response.ok) {
          tableEl.innerHTML = '<div class="error">Failed to load reports</div>';
          return;
        }

        const data = await response.json();
        reportsData = data.reports;

        // Update pending badge
        const pendingCount = reportsData.filter(r => r.status === 'pending').length;
        const badge = document.getElementById('pending-reports-badge');
        badge.textContent = pendingCount > 0 ? pendingCount : '';

        if (data.reports.length === 0) {
          tableEl.innerHTML = '<div class="loading">No reports found</div>';
          return;
        }

        tableEl.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Content</th>
                <th>Reported By</th>
                <th>Content Author</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${data.reports.map(report => `
                <tr id="report-row-${report.id}">
                  <td class="user-id">${report.id}</td>
                  <td><span class="report-reason">${escapeHtml(report.content_type || '')}</span></td>
                  <td>
                    <div class="report-preview">${escapeHtml(report.content_preview || 'Content unavailable')}</div>
                  </td>
                  <td>
                    <div class="user-name">${escapeHtml(report.reporter_name || 'Unknown')}</div>
                  </td>
                  <td>
                    <div class="user-name">${escapeHtml(report.content_author_name || 'Unknown')}</div>
                    ${report.content_author_id ? `<button class="action-btn" onclick="showUserHistory(${report.content_author_id})">History</button>` : ''}
                  </td>
                  <td><span class="report-reason">${escapeHtml(report.reason || '')}</span></td>
                  <td><span class="report-status ${escapeHtml(report.status || '')}">${escapeHtml(report.status || '')}</span></td>
                  <td class="user-date">${formatDate(report.created_at)}</td>
                  <td>
                    ${report.status === 'pending' ? `
                      <button class="action-btn" onclick="updateReportStatus(${report.id}, 'reviewed')">Mark Reviewed</button>
                      <button class="action-btn" onclick="updateReportStatus(${report.id}, 'dismissed')">Dismiss</button>
                      ${report.content_author_id ? `<button class="action-btn delete" onclick="showModActionModal(${report.id}, ${report.content_author_id}, '${escapeJsString(report.content_author_name || 'Unknown')}')">Take Action</button>` : ''}
                    ` : `
                      ${report.reviewed_by_name ? `<span class="text-muted">by ${escapeHtml(report.reviewed_by_name)}</span>` : ''}
                    `}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

      } catch (error) {
        console.error('Error loading reports:', error);
        tableEl.innerHTML = '<div class="error">Failed to load reports</div>';
      }
    }

    async function updateReportStatus(reportId, status) {
      try {
        const response = await Auth.apiRequest(`/api/reports/admin/${reportId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });

        if (response.ok) {
          loadReports();
        } else {
          alert('Failed to update report status');
        }
      } catch (error) {
        console.error('Error updating report:', error);
        alert('Failed to update report');
      }
    }

    function showModActionModal(reportId, targetUserId, targetUserName) {
      document.getElementById('mod-report-id').value = reportId;
      document.getElementById('mod-target-user-id').value = targetUserId;
      document.getElementById('mod-target-info').innerHTML = `
        <strong>Target User:</strong> ${escapeHtml(targetUserName)} (ID: ${targetUserId})
      `;
      document.getElementById('mod-action-type').value = '';
      document.getElementById('mod-action-reason').value = '';
      document.getElementById('mod-action-modal').classList.add('open');
    }

    function closeModActionModal() {
      document.getElementById('mod-action-modal').classList.remove('open');
    }

    async function submitModAction() {
      const reportId = document.getElementById('mod-report-id').value;
      const targetUserId = parseInt(document.getElementById('mod-target-user-id').value);
      const actionType = document.getElementById('mod-action-type').value;
      const reason = document.getElementById('mod-action-reason').value.trim();

      if (!actionType) {
        alert('Please select an action');
        return;
      }
      if (!reason) {
        alert('Please provide a reason');
        return;
      }

      try {
        const response = await Auth.apiRequest('/api/reports/admin/action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            report_id: reportId ? parseInt(reportId) : null,
            action_type: actionType,
            target_user_id: targetUserId,
            reason: reason
          })
        });

        if (response.ok) {
          closeModActionModal();
          loadReports();
          alert('Moderation action taken successfully');
        } else {
          const errorData = await response.json().catch(() => ({}));
          alert(errorData.detail || 'Failed to take action');
        }
      } catch (error) {
        console.error('Error taking moderation action:', error);
        alert('Failed to take moderation action');
      }
    }

    async function showUserHistory(userId) {
      document.getElementById('user-history-modal').classList.add('open');
      const content = document.getElementById('user-history-content');
      content.innerHTML = '<div class="loading">Loading history...</div>';

      try {
        const response = await Auth.apiRequest(`/api/reports/admin/users/${userId}/history`);

        if (!response.ok) {
          content.innerHTML = '<div class="error">Failed to load history</div>';
          return;
        }

        const data = await response.json();

        let html = `
          <div class="mod-target-info">
            <strong>${escapeHtml(data.user_name || 'Unknown')}</strong>
            ${data.user_email ? ` (${escapeHtml(data.user_email)})` : ''}
            <br>
            <span class="text-muted">Total reports against this user: ${data.report_count}</span>
          </div>
        `;

        if (data.warnings.length > 0) {
          html += `<div class="history-section">
            <h4>Warnings (${data.warnings.length})</h4>
            ${data.warnings.map(w => `
              <div class="history-item">
                <span class="action-type">${escapeHtml(w.warning_type || '')}</span>
                ${escapeHtml(w.message || '')}
                <div class="date">Issued by ${escapeHtml(w.issued_by_name || 'Admin')} on ${formatDate(w.created_at)}</div>
              </div>
            `).join('')}
          </div>`;
        }

        if (data.actions.length > 0) {
          html += `<div class="history-section">
            <h4>Moderation Actions (${data.actions.length})</h4>
            ${data.actions.map(a => `
              <div class="history-item">
                <span class="action-type">${escapeHtml(a.action_type || '')}</span>
                ${escapeHtml(a.reason || '')}
                <div class="date">By ${escapeHtml(a.moderator_name || 'Admin')} on ${formatDate(a.created_at)}</div>
              </div>
            `).join('')}
          </div>`;
        }

        if (data.warnings.length === 0 && data.actions.length === 0) {
          html += '<div class="text-muted">No moderation history for this user.</div>';
        }

        content.innerHTML = html;

      } catch (error) {
        console.error('Error loading user history:', error);
        content.innerHTML = '<div class="error">Failed to load history</div>';
      }
    }

    function closeUserHistoryModal() {
      document.getElementById('user-history-modal').classList.remove('open');
    }

    // Load users and analytics on page load
    loadUsers();
    loadAnalytics();
  </script>
</body>
</html>
