<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - User List | NCC</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: #0e0e0e;
      color: #fff;
      min-height: 100vh;
      padding: 24px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding-bottom: 16px;
      border-bottom: 1px solid #333;
    }

    h1 {
      font-family: 'Orbitron', sans-serif;
      color: #1db954;
      font-size: 1.5rem;
    }

    .back-link {
      color: rgba(255, 255, 255, 0.6);
      text-decoration: none;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: #1db954;
    }

    .stats {
      background: #1a1a1a;
      padding: 16px 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      display: flex;
      gap: 32px;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 600;
      color: #1db954;
    }

    .stat-label {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.85rem;
    }

    .user-table {
      width: 100%;
      background: #1a1a1a;
      border-radius: 12px;
      overflow: hidden;
    }

    .user-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .user-table th,
    .user-table td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid #333;
    }

    .user-table th {
      background: #252525;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .user-table tr:last-child td {
      border-bottom: none;
    }

    .user-table tr:hover td {
      background: rgba(255, 255, 255, 0.03);
    }

    .user-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #333;
      object-fit: cover;
    }

    .user-name {
      font-weight: 500;
    }

    .user-email {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.9rem;
    }

    .user-id {
      color: rgba(255, 255, 255, 0.4);
      font-family: monospace;
    }

    .user-date {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.85rem;
    }

    .expand-btn {
      background: transparent;
      border: 1px solid #555;
      color: rgba(255, 255, 255, 0.6);
      width: 28px;
      height: 28px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .expand-btn:hover {
      background: #333;
      color: #fff;
    }

    .expand-btn.expanded {
      background: #1db954;
      border-color: #1db954;
      color: #fff;
    }

    .memberships-row {
      display: none;
    }

    .memberships-row.show {
      display: table-row;
    }

    .memberships-row td {
      background: #151515;
      padding: 12px 16px;
    }

    .memberships-content {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .membership-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #252525;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 0.8rem;
    }

    .membership-tag .icon {
      font-size: 1rem;
    }

    .membership-tag .category-name {
      color: #1db954;
    }

    .membership-tag .group-name {
      color: rgba(255, 255, 255, 0.8);
    }

    .membership-tag .separator {
      color: rgba(255, 255, 255, 0.3);
    }

    .no-memberships {
      color: rgba(255, 255, 255, 0.4);
      font-style: italic;
    }

    .loading-memberships {
      color: rgba(255, 255, 255, 0.5);
    }

    .loading {
      text-align: center;
      padding: 48px;
      color: rgba(255, 255, 255, 0.6);
    }

    .error {
      text-align: center;
      padding: 48px;
      color: #e74c3c;
    }

    .export-btn {
      background: #1db954;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 500;
      transition: all 0.2s;
    }

    .export-btn:hover {
      background: #1ed760;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .tab-btn {
      background: #252525;
      color: rgba(255, 255, 255, 0.7);
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 500;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      background: #333;
    }

    .tab-btn.active {
      background: #1db954;
      color: #fff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .action-btn {
      background: transparent;
      border: 1px solid #555;
      color: rgba(255, 255, 255, 0.7);
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      margin-right: 4px;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: #333;
    }

    .action-btn.delete {
      border-color: #e74c3c;
      color: #e74c3c;
    }

    .action-btn.delete:hover {
      background: #e74c3c;
      color: #fff;
    }

    .action-btn.active {
      background: #1db954;
      border-color: #1db954;
      color: #fff;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      margin-left: 4px;
    }

    .badge.pinned {
      background: #f39c12;
      color: #000;
    }

    .badge.locked {
      background: #e74c3c;
      color: #fff;
    }

    .post-title {
      font-weight: 500;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .post-body {
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.85rem;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    @media (max-width: 768px) {
      .user-table {
        overflow-x: auto;
      }

      .user-table table {
        min-width: 600px;
      }

      .stats {
        flex-direction: column;
        gap: 16px;
      }

      .tabs {
        flex-wrap: wrap;
      }
    }

    /* Utility classes to replace inline styles */
    .mb-24 { margin-bottom: 24px; }
    .mb-16 { margin-bottom: 16px; }
    .w-100 { width: 100%; }
    .section-title {
      color: #1db954;
      margin-bottom: 12px;
      font-size: 0.9rem;
    }
    .categories-container {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }
    .text-muted { color: rgba(255, 255, 255, 0.5); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Admin Dashboard</h1>
      <div>
        <a href="/profile.html" class="back-link">Back to Profile</a>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="showTab('users', this)">Users</button>
      <button class="tab-btn" onclick="showTab('posts', this)">Posts</button>
      <button class="tab-btn" onclick="showTab('comments', this)">Comments</button>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content active">
      <!-- Analytics Dashboard -->
      <div class="stats" id="analytics-stats">
        <div class="stat">
          <div class="stat-value" id="total-users">-</div>
          <div class="stat-label">Total Users</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="users-7d">-</div>
          <div class="stat-label">New (7 days)</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="total-collections">-</div>
          <div class="stat-label">Collection Items</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="total-posts">-</div>
          <div class="stat-label">Forum Posts</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="posts-7d">-</div>
          <div class="stat-label">Posts (7 days)</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="avg-collection">-</div>
          <div class="stat-label">Avg Items/User</div>
        </div>
      </div>

      <!-- Top Categories -->
      <div class="stats mb-24" id="categories-stats">
        <div class="w-100">
          <h3 class="section-title">Top Categories</h3>
          <div id="top-categories" class="categories-container">
            <span class="text-muted">Loading...</span>
          </div>
        </div>
      </div>

      <div class="mb-16">
        <button class="export-btn" onclick="exportCSV()">Export Users CSV</button>
      </div>

      <div class="user-table" id="user-table">
        <div class="loading">Loading users...</div>
      </div>
    </div>

    <!-- Posts Tab -->
    <div id="posts-tab" class="tab-content">
      <div class="user-table" id="posts-table">
        <div class="loading">Loading posts...</div>
      </div>
    </div>

    <!-- Comments Tab -->
    <div id="comments-tab" class="tab-content">
      <div class="user-table" id="comments-table">
        <div class="loading">Loading comments...</div>
      </div>
    </div>
  </div>

  <script src="/js/config.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    let usersData = [];
    let postsData = [];
    let commentsData = [];

    function showTab(tabName, clickedBtn) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      if (clickedBtn) clickedBtn.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`${tabName}-tab`).classList.add('active');

      // Load data if needed
      if (tabName === 'posts' && postsData.length === 0) {
        loadPosts();
      } else if (tabName === 'comments' && commentsData.length === 0) {
        loadComments();
      }
    }

    async function loadUsers() {
      const tableEl = document.getElementById('user-table');

      // Check auth
      Auth.init();
      if (!Auth.isAuthenticated()) {
        window.location.href = '/';
        return;
      }

      try {
        const response = await Auth.apiRequest('/api/admin/users');

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          const errorMsg = errorData.detail || 'Access denied';
          tableEl.innerHTML = `<div class="error">${escapeHtml(errorMsg)}</div>`;
          return;
        }

        const data = await response.json();
        usersData = data.users;

        // Update stats
        document.getElementById('total-users').textContent = data.total;

        // Render table
        tableEl.innerHTML = `
          <table>
            <thead>
              <tr>
                <th style="width: 40px;"></th>
                <th>ID</th>
                <th>User</th>
                <th>Email</th>
                <th>Joined</th>
              </tr>
            </thead>
            <tbody>
              ${data.users.map(user => `
                <tr class="user-main-row" data-user-id="${user.id}">
                  <td>
                    <button class="expand-btn" onclick="toggleMemberships(${user.id}, this)" title="Show groups">â–¼</button>
                  </td>
                  <td class="user-id">${user.id}</td>
                  <td>
                    <div class="user-row">
                      <img src="${user.picture || ''}"
                           alt=""
                           class="user-avatar"
                           onerror="this.style.display='none'">
                      <span class="user-name">${escapeHtml(user.name || 'No name')}</span>
                    </div>
                  </td>
                  <td class="user-email">${escapeHtml(user.email || '-')}</td>
                  <td class="user-date">${formatDate(user.created_at)}</td>
                </tr>
                <tr class="memberships-row" id="memberships-row-${user.id}">
                  <td colspan="5">
                    <div class="memberships-content" id="memberships-content-${user.id}">
                      <span class="loading-memberships">Loading...</span>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

      } catch (error) {
        console.error('Error loading users:', error);
        tableEl.innerHTML = '<div class="error">Failed to load users. Make sure you have admin access.</div>';
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr.replace(' ', 'T') + 'Z');
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function exportCSV() {
      if (usersData.length === 0) {
        alert('No data to export');
        return;
      }

      const headers = ['ID', 'Name', 'Email', 'Joined'];
      const rows = usersData.map(u => [
        u.id,
        (u.name || '').replace(/,/g, ' '),
        (u.email || '').replace(/,/g, ' '),
        u.created_at || ''
      ]);

      let csv = headers.join(',') + '\n';
      csv += rows.map(r => r.join(',')).join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ncc-users-' + new Date().toISOString().slice(0, 10) + '.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function loadAnalytics() {
      try {
        const response = await Auth.apiRequest('/api/admin/analytics');

        if (!response.ok) {
          console.error('Failed to load analytics');
          return;
        }

        const data = await response.json();

        // Update stats
        document.getElementById('total-users').textContent = data.total_users;
        document.getElementById('users-7d').textContent = data.users_last_7_days;
        document.getElementById('total-collections').textContent = data.total_collections;
        document.getElementById('total-posts').textContent = data.total_posts;
        document.getElementById('posts-7d').textContent = data.posts_last_7_days;
        document.getElementById('avg-collection').textContent = data.collection_stats?.avg_per_user || 0;

        // Update top categories
        const categoriesEl = document.getElementById('top-categories');
        if (data.top_categories && data.top_categories.length > 0) {
          categoriesEl.innerHTML = data.top_categories.map(cat => `
            <div style="text-align: center;">
              <div style="font-size: 1.5rem; font-weight: 600; color: #1db954;">${cat.count}</div>
              <div style="color: rgba(255,255,255,0.6); font-size: 0.8rem;">${escapeHtml(cat.name)}</div>
            </div>
          `).join('');
        } else {
          categoriesEl.innerHTML = '<span style="color: rgba(255,255,255,0.5);">No categories yet</span>';
        }

      } catch (error) {
        console.error('Error loading analytics:', error);
      }
    }

    async function loadPosts() {
      const tableEl = document.getElementById('posts-table');

      try {
        const response = await Auth.apiRequest('/api/admin/posts?limit=50');

        if (!response.ok) {
          tableEl.innerHTML = '<div class="error">Failed to load posts</div>';
          return;
        }

        const data = await response.json();
        postsData = data.posts;

        if (data.posts.length === 0) {
          tableEl.innerHTML = '<div class="loading">No posts yet</div>';
          return;
        }

        tableEl.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Author</th>
                <th>Category</th>
                <th>Votes</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${data.posts.map(post => `
                <tr id="post-row-${post.id}">
                  <td class="user-id">${post.id}</td>
                  <td>
                    <div class="post-title">${escapeHtml(post.title)}</div>
                    <div class="post-body">${escapeHtml(post.body)}</div>
                  </td>
                  <td>
                    <div class="user-name">${escapeHtml(post.author?.name || 'Unknown')}</div>
                    <div class="user-email">${escapeHtml(post.author?.email || '-')}</div>
                  </td>
                  <td>${escapeHtml(post.category_name || '-')}</td>
                  <td>+${post.upvote_count} / -${post.downvote_count}</td>
                  <td>
                    ${post.is_pinned ? '<span class="badge pinned">Pinned</span>' : ''}
                    ${post.is_locked ? '<span class="badge locked">Locked</span>' : ''}
                  </td>
                  <td>
                    <button class="action-btn ${post.is_pinned ? 'active' : ''}" onclick="togglePin(${post.id})">Pin</button>
                    <button class="action-btn ${post.is_locked ? 'active' : ''}" onclick="toggleLock(${post.id})">Lock</button>
                    <button class="action-btn delete" onclick="deletePost(${post.id})">Delete</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

      } catch (error) {
        console.error('Error loading posts:', error);
        tableEl.innerHTML = '<div class="error">Failed to load posts</div>';
      }
    }

    async function loadComments() {
      const tableEl = document.getElementById('comments-table');

      try {
        const response = await Auth.apiRequest('/api/admin/comments?limit=50');

        if (!response.ok) {
          tableEl.innerHTML = '<div class="error">Failed to load comments</div>';
          return;
        }

        const data = await response.json();
        commentsData = data.comments;

        if (data.comments.length === 0) {
          tableEl.innerHTML = '<div class="loading">No comments yet</div>';
          return;
        }

        tableEl.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Comment</th>
                <th>Author</th>
                <th>Post</th>
                <th>Votes</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${data.comments.map(comment => `
                <tr id="comment-row-${comment.id}">
                  <td class="user-id">${comment.id}</td>
                  <td>
                    <div class="post-body" style="max-width: 300px;">${escapeHtml(comment.body)}</div>
                  </td>
                  <td>
                    <div class="user-name">${escapeHtml(comment.author?.name || 'Unknown')}</div>
                    <div class="user-email">${escapeHtml(comment.author?.email || '-')}</div>
                  </td>
                  <td>
                    <div class="post-title" style="max-width: 150px;">${escapeHtml(comment.post_title)}</div>
                  </td>
                  <td>+${comment.upvote_count} / -${comment.downvote_count}</td>
                  <td class="user-date">${formatDate(comment.created_at)}</td>
                  <td>
                    <button class="action-btn delete" onclick="deleteComment(${comment.id})">Delete</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

      } catch (error) {
        console.error('Error loading comments:', error);
        tableEl.innerHTML = '<div class="error">Failed to load comments</div>';
      }
    }

    async function togglePin(postId) {
      try {
        const response = await Auth.apiRequest(`/api/admin/posts/${postId}/pin`, { method: 'PUT' });
        if (response.ok) {
          const data = await response.json();
          // Reload posts to refresh state
          postsData = [];
          loadPosts();
        }
      } catch (error) {
        console.error('Error toggling pin:', error);
        alert('Failed to toggle pin status');
      }
    }

    async function toggleLock(postId) {
      try {
        const response = await Auth.apiRequest(`/api/admin/posts/${postId}/lock`, { method: 'PUT' });
        if (response.ok) {
          const data = await response.json();
          // Reload posts to refresh state
          postsData = [];
          loadPosts();
        }
      } catch (error) {
        console.error('Error toggling lock:', error);
        alert('Failed to toggle lock status');
      }
    }

    async function deletePost(postId) {
      if (!confirm('Are you sure you want to delete this post? This cannot be undone.')) {
        return;
      }

      try {
        const response = await Auth.apiRequest(`/api/admin/posts/${postId}`, { method: 'DELETE' });
        if (response.ok) {
          // Remove row from table
          const row = document.getElementById(`post-row-${postId}`);
          if (row) row.remove();
          postsData = postsData.filter(p => p.id !== postId);
        } else {
          alert('Failed to delete post');
        }
      } catch (error) {
        console.error('Error deleting post:', error);
        alert('Failed to delete post');
      }
    }

    async function deleteComment(commentId) {
      if (!confirm('Are you sure you want to delete this comment? This cannot be undone.')) {
        return;
      }

      try {
        const response = await Auth.apiRequest(`/api/admin/comments/${commentId}`, { method: 'DELETE' });
        if (response.ok) {
          // Remove row from table
          const row = document.getElementById(`comment-row-${commentId}`);
          if (row) row.remove();
          commentsData = commentsData.filter(c => c.id !== commentId);
        } else {
          alert('Failed to delete comment');
        }
      } catch (error) {
        console.error('Error deleting comment:', error);
        alert('Failed to delete comment');
      }
    }

    // Cache for loaded memberships
    const membershipsCache = {};

    async function toggleMemberships(userId, btn) {
      const row = document.getElementById(`memberships-row-${userId}`);
      const content = document.getElementById(`memberships-content-${userId}`);
      const isExpanded = row.classList.contains('show');

      if (isExpanded) {
        // Collapse
        row.classList.remove('show');
        btn.classList.remove('expanded');
        btn.textContent = 'â–¼';
        return;
      }

      // Expand
      row.classList.add('show');
      btn.classList.add('expanded');
      btn.textContent = 'â–²';

      // Check cache
      if (membershipsCache[userId]) {
        renderMemberships(userId, membershipsCache[userId]);
        return;
      }

      // Fetch memberships
      try {
        const response = await Auth.apiRequest(`/api/admin/users/${userId}/memberships`);
        if (response.ok) {
          const data = await response.json();
          membershipsCache[userId] = data.memberships;
          renderMemberships(userId, data.memberships);
        } else {
          content.innerHTML = '<span class="no-memberships">Failed to load</span>';
        }
      } catch (error) {
        console.error('Error loading memberships:', error);
        content.innerHTML = '<span class="no-memberships">Failed to load</span>';
      }
    }

    function renderMemberships(userId, memberships) {
      const content = document.getElementById(`memberships-content-${userId}`);

      if (!memberships || memberships.length === 0) {
        content.innerHTML = '<span class="no-memberships">No group memberships</span>';
        return;
      }

      // Group by category
      const byCategory = {};
      memberships.forEach(m => {
        const catKey = m.category_id || 'unknown';
        if (!byCategory[catKey]) {
          byCategory[catKey] = {
            name: m.category_name || 'Unknown',
            icon: m.category_icon || 'ðŸ“',
            groups: []
          };
        }
        if (m.group_name) {
          byCategory[catKey].groups.push(m.group_name);
        }
      });

      let html = '';
      Object.values(byCategory).forEach(cat => {
        if (cat.groups.length > 0) {
          // Category with groups
          cat.groups.forEach(groupName => {
            html += `
              <div class="membership-tag">
                <span class="icon">${escapeHtml(cat.icon)}</span>
                <span class="category-name">${escapeHtml(cat.name)}</span>
                <span class="separator">â€º</span>
                <span class="group-name">${escapeHtml(groupName)}</span>
              </div>
            `;
          });
        } else {
          // Just category membership (no specific group)
          html += `
            <div class="membership-tag">
              <span class="icon">${escapeHtml(cat.icon)}</span>
              <span class="category-name">${escapeHtml(cat.name)}</span>
            </div>
          `;
        }
      });

      content.innerHTML = html;
    }

    // Load users and analytics on page load
    loadUsers();
    loadAnalytics();
  </script>
</body>
</html>
