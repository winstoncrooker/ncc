<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
  <title>My Profile - Niche Collector Connector</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1db954">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/auth.css">
  <link rel="stylesheet" href="css/profile.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
</head>
<body>
  <!-- Header -->
  <header class="profile-header">
    <div class="header-content">
      <a href="/" class="site-logo">
        <span class="logo-icon">üéµ</span>
        <span class="logo-text">NCC</span>
      </a>
      <div class="header-actions">
        <div id="user-menu" class="user-menu"></div>
        <button class="messages-toggle-btn" id="messages-toggle-btn" title="Messages">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
            <polyline points="22,6 12,13 2,6"/>
          </svg>
          <span class="unread-badge" id="unread-badge"></span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Profile Content -->
  <main class="profile-main">
    <!-- Profile Hero Section -->
    <section class="profile-hero">
      <!-- Background Image -->
      <div class="hero-background" id="hero-background">
        <button class="change-bg-btn" id="change-bg-btn" title="Change background">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
        </button>
      </div>

      <!-- Profile Card -->
      <div class="profile-card">
        <div class="profile-left">
          <!-- Profile Picture -->
          <div class="profile-picture-wrapper">
            <img src="" alt="Profile" class="profile-picture" id="profile-picture">
            <button class="upload-photo-btn" id="upload-photo-btn" title="Upload photo">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
        </div>

        <div class="profile-right">
          <div class="profile-name-row">
            <h1 class="profile-name" id="profile-name">Loading...</h1>
            <span class="profile-pronouns" id="profile-pronouns"></span>
          </div>
          <p class="profile-bio" id="profile-bio"></p>
          <button class="edit-profile-btn" id="edit-profile-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            Edit Profile
          </button>
        </div>
      </div>
    </section>

    <!-- Showcase Section -->
    <section class="showcase-section">
      <div class="section-header">
        <h2>
          <span class="section-icon">‚ú®</span>
          My Showcase
        </h2>
        <button class="add-btn" id="add-to-showcase-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Record
        </button>
      </div>
      <div class="showcase-grid" id="showcase-grid">
        <div class="showcase-empty" id="showcase-empty">
          <div class="empty-icon">üìÄ</div>
          <p>No records in your showcase yet</p>
          <span>Feature your favorite albums here!</span>
        </div>
      </div>
    </section>

    <!-- Collection Section -->
    <section class="collection-section">
      <div class="section-header">
        <h2>
          <span class="section-icon">üìö</span>
          My Collection
          <span class="collection-count" id="collection-count">0</span>
        </h2>
        <button class="add-btn" id="add-record-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Record
        </button>
      </div>
      <div class="collection-grid" id="collection-grid">
        <div class="collection-empty" id="collection-empty">
          <div class="empty-icon">üéµ</div>
          <p>Your collection is empty</p>
          <span>Start adding your vinyl records!</span>
        </div>
      </div>
    </section>

    <!-- Friends Section -->
    <section class="friends-section">
      <div class="section-header">
        <h2>
          <span class="section-icon">üë•</span>
          Friends
          <span class="friends-count" id="friends-count">0</span>
        </h2>
        <button class="add-btn" id="add-friend-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="8.5" cy="7" r="4"/>
            <line x1="20" y1="8" x2="20" y2="14"/>
            <line x1="23" y1="11" x2="17" y2="11"/>
          </svg>
          Add Friend
        </button>
      </div>
      <div class="friends-grid" id="friends-grid">
        <div class="friends-empty" id="friends-empty">
          <div class="empty-icon">ü§ù</div>
          <p>No friends yet</p>
          <span>Connect with other collectors!</span>
        </div>
      </div>
    </section>
  </main>

  <!-- AI Assistant Toggle -->
  <button class="ai-toggle-btn" id="ai-toggle-btn" title="AI Assistant">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    </svg>
  </button>

  <!-- AI Sidebar -->
  <aside class="ai-sidebar" id="ai-sidebar">
    <div class="ai-header">
      <div class="ai-title">
        <span class="ai-icon">ü§ñ</span>
        <h3>AI Assistant</h3>
      </div>
      <button class="ai-close" id="ai-close-btn">&times;</button>
    </div>
    <div class="ai-chat" id="ai-chat-container">
      <div class="ai-welcome">
        <div class="welcome-icon">üëã</div>
        <h4>Hey there!</h4>
        <p>I can help you with:</p>
        <ul>
          <li>Writing your bio</li>
          <li>Adding records to your collection</li>
          <li>Finding albums on Discogs</li>
          <li>Choosing what to showcase</li>
        </ul>
      </div>
    </div>
    <form class="ai-form" id="ai-input-form">
      <input type="file" id="ai-file-input" accept=".txt" style="display: none;">
      <button type="button" id="ai-upload-btn" class="ai-upload-btn" title="Upload .txt file with album list">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
      </button>
      <input type="text" id="ai-input" placeholder="Type a message..." autocomplete="off">
      <button type="submit" id="ai-send-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </form>
  </aside>

  <!-- Overlay for sidebar -->
  <div class="sidebar-overlay" id="sidebar-overlay"></div>

  <!-- Messages Sidebar -->
  <aside class="messages-sidebar" id="messages-sidebar">
    <div class="messages-header">
      <div class="messages-title">
        <span class="messages-icon">üí¨</span>
        <h3>Messages</h3>
      </div>
      <button class="messages-close" id="messages-close-btn">&times;</button>
    </div>
    <!-- Friends List View (for starting conversations) -->
    <div class="friends-list-view" id="friends-list-view">
      <div class="friends-message-list" id="friends-message-list">
        <div class="friends-list-empty">
          <div class="empty-icon">üë•</div>
          <p>No friends yet</p>
          <span>Add friends to start messaging!</span>
        </div>
      </div>
    </div>
    <!-- Individual Conversation View -->
    <div class="conversation-view" id="conversation-view" style="display:none">
      <div class="conversation-header">
        <button class="back-btn" id="conversation-back-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
        </button>
        <img class="conversation-avatar" id="conversation-avatar" src="" alt="">
        <span class="conversation-with" id="conversation-with"></span>
      </div>
      <div class="messages-list" id="messages-list"></div>
      <form class="message-form" id="message-form">
        <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" maxlength="1000">
        <button type="submit" class="send-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </form>
    </div>
  </aside>

  <!-- Add Friend Modal -->
  <div class="modal" id="add-friend-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Friend</h3>
        <button class="modal-close" id="add-friend-close">&times;</button>
      </div>
      <div class="add-friend-content">
        <p class="modal-subtitle">Enter their exact profile name (case-sensitive)</p>
        <div class="form-group">
          <input type="text" id="friend-name-input" placeholder="Profile name" maxlength="100">
        </div>
        <div class="friend-search-result" id="friend-search-result"></div>
        <div class="form-actions">
          <button type="button" class="btn-cancel" id="add-friend-cancel">Cancel</button>
          <button type="button" class="btn-save" id="add-friend-confirm" disabled>Add Friend</button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Profile Modal -->
  <div class="modal" id="view-profile-modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3>Profile</h3>
        <button class="modal-close" id="view-profile-close">&times;</button>
      </div>
      <div class="view-profile-content" id="view-profile-content">
        <div class="view-profile-header">
          <div class="view-profile-bg" id="view-profile-bg"></div>
          <img class="view-profile-picture" id="view-profile-picture" src="" alt="">
        </div>
        <div class="view-profile-info">
          <div class="view-profile-name-row">
            <h2 id="view-profile-name"></h2>
            <span class="view-profile-pronouns" id="view-profile-pronouns"></span>
          </div>
          <p class="view-profile-bio" id="view-profile-bio"></p>
          <div class="view-profile-stats">
            <span id="view-profile-collection-count">0 records</span>
          </div>
          <div class="view-profile-actions" id="view-profile-actions">
            <button class="btn-message" id="view-profile-message">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
              Message
            </button>
            <button class="btn-unfollow" id="view-profile-unfollow">Unfollow</button>
          </div>
        </div>
        <div class="view-profile-showcase">
          <h3>Showcase</h3>
          <div class="view-showcase-grid" id="view-showcase-grid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div class="modal" id="edit-profile-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Profile</h3>
        <button class="modal-close" id="edit-profile-close">&times;</button>
      </div>
      <form id="edit-profile-form">
        <div class="form-group">
          <label for="edit-name">Display Name</label>
          <input type="text" id="edit-name" maxlength="100" placeholder="Your name">
        </div>
        <div class="form-group">
          <label for="edit-pronouns">Pronouns</label>
          <input type="text" id="edit-pronouns" placeholder="e.g., they/them, she/her, he/him" maxlength="50">
        </div>
        <div class="form-group">
          <label for="edit-bio">Bio</label>
          <textarea id="edit-bio" rows="4" maxlength="500" placeholder="Tell us about yourself and your vinyl journey..."></textarea>
          <span class="char-count"><span id="bio-char-count">0</span>/500</span>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-cancel" id="edit-profile-cancel">Cancel</button>
          <button type="submit" class="btn-save">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Record Modal -->
  <div class="modal" id="add-record-modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3>Add Record</h3>
        <button class="modal-close" id="add-record-close">&times;</button>
      </div>
      <div class="modal-tabs">
        <button class="tab-btn active" data-tab="manual">Manual Entry</button>
        <button class="tab-btn" data-tab="search">Search Discogs</button>
      </div>
      <div class="tab-content active" id="tab-manual">
        <form id="manual-add-form">
          <div class="form-row">
            <div class="form-group">
              <label for="manual-artist">Artist *</label>
              <input type="text" id="manual-artist" required placeholder="Artist name">
            </div>
            <div class="form-group">
              <label for="manual-album">Album *</label>
              <input type="text" id="manual-album" required placeholder="Album title">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="manual-year">Year</label>
              <input type="number" id="manual-year" min="1900" max="2030" placeholder="Release year">
            </div>
            <div class="form-group">
              <label for="manual-cover">Cover Image URL</label>
              <input type="url" id="manual-cover" placeholder="https://...">
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-cancel" id="manual-add-cancel">Cancel</button>
            <button type="submit" class="btn-save">Add to Collection</button>
          </div>
        </form>
      </div>
      <div class="tab-content" id="tab-search">
        <form id="discogs-search-form" class="search-form">
          <input type="text" id="discogs-query" placeholder="Search for artist or album...">
          <button type="submit" class="btn-search">Search</button>
        </form>
        <div class="search-results" id="search-results"></div>
      </div>
    </div>
  </div>

  <!-- Showcase Modal -->
  <div class="modal" id="showcase-modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3>Add to Showcase</h3>
        <button class="modal-close" id="showcase-modal-close">&times;</button>
      </div>
      <p class="modal-subtitle">Select a record to feature on your profile</p>
      <div class="showcase-select-grid" id="showcase-select-grid"></div>
    </div>
  </div>

  <!-- Image Cropper Modal -->
  <div class="modal" id="cropper-modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 id="cropper-title">Adjust Image</h3>
        <button class="modal-close" id="cropper-modal-close">&times;</button>
      </div>
      <div class="cropper-container">
        <img id="cropper-image" src="" alt="Crop preview">
      </div>
      <div class="cropper-controls">
        <button type="button" class="btn-icon" id="crop-rotate-left" title="Rotate left">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38"/>
          </svg>
        </button>
        <button type="button" class="btn-icon" id="crop-rotate-right" title="Rotate right">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38"/>
          </svg>
        </button>
        <button type="button" class="btn-icon" id="crop-zoom-in" title="Zoom in">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
            <line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/>
          </svg>
        </button>
        <button type="button" class="btn-icon" id="crop-zoom-out" title="Zoom out">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
            <line x1="8" y1="11" x2="14" y2="11"/>
          </svg>
        </button>
        <button type="button" class="btn-icon" id="crop-reset" title="Reset">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
            <path d="M3 3v5h5"/>
          </svg>
        </button>
      </div>
      <div class="form-actions">
        <button type="button" class="btn-cancel" id="cropper-cancel">Cancel</button>
        <button type="button" class="btn-save" id="cropper-save">
          <span class="btn-text">Save Image</span>
          <span class="btn-loading" style="display:none;">Uploading...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Hidden file input for photo upload -->
  <input type="file" id="photo-upload-input" accept="image/*" style="display:none">
  <input type="file" id="bg-upload-input" accept="image/*" style="display:none">

  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/profile.js"></script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW error:', err));
    }
  </script>
</body>
</html>
