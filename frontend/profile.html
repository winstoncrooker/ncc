<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
  <meta name="description" content="Connect with fellow collectors, showcase your vinyl collection, and discover new records">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>My Profile - Niche Collector Connector</title>

  <!-- Canonical URL -->
  <link rel="canonical" href="https://niche-collector.pages.dev/profile.html">

  <!-- OpenGraph Tags -->
  <meta property="og:type" content="profile">
  <meta property="og:title" content="My Profile - Niche Collector Connector">
  <meta property="og:description" content="Manage your collection, showcase your favorite records, and connect with fellow collectors on Niche Collector Connector.">
  <meta property="og:url" content="https://niche-collector.pages.dev/profile.html">
  <meta property="og:image" content="https://niche-collector.pages.dev/images/og-image.png">
  <meta property="og:site_name" content="Niche Collector Connector">

  <!-- Twitter Card Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="My Profile - Niche Collector Connector">
  <meta name="twitter:description" content="Manage your collection, showcase your favorite records, and connect with fellow collectors on Niche Collector Connector.">
  <meta name="twitter:image" content="https://niche-collector.pages.dev/images/og-image.png">

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1db954">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/auth.css">
  <link rel="stylesheet" href="css/profile.css">
  <link rel="stylesheet" href="css/forums.css">
  <link rel="stylesheet" href="css/marketplace.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
</head>
<body>
  <!-- Skip to main content link for keyboard users -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Header -->
  <header class="profile-header" role="banner">
    <div class="header-content">
      <div class="site-logo">
        <span class="logo-text" aria-label="Niche Collector Connector">NCC</span>
      </div>
      <nav class="main-tabs" role="navigation" aria-label="Main navigation">
        <button class="main-tab-btn active" data-tab="profile" aria-pressed="true" aria-controls="profile-view">Profile</button>
        <button class="main-tab-btn" data-tab="marketplace" aria-pressed="false" aria-controls="marketplace-view">Marketplace</button>
        <button class="main-tab-btn" data-tab="forums" aria-pressed="false" aria-controls="forums-view">Forums</button>
      </nav>
      <!-- Global Search -->
      <div class="global-search" id="global-search" role="search">
        <div class="search-input-wrapper">
          <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
          </svg>
          <input type="text" id="global-search-input" placeholder="Search users, collections, posts..." autocomplete="off" aria-label="Search" aria-expanded="false" aria-controls="search-results-dropdown" aria-autocomplete="list">
          <button class="search-clear-btn" id="search-clear-btn" title="Clear search" aria-label="Clear search" style="display: none;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
        <div class="search-results-dropdown" id="search-results-dropdown" role="listbox" aria-label="Search results" style="display: none;"></div>
      </div>
      <div class="header-actions">
        <button class="theme-toggle" id="theme-toggle" title="Toggle theme" aria-label="Toggle dark/light theme">
          <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
          <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
        </button>
        <div id="user-menu" class="user-menu"></div>
        <button class="messages-toggle-btn" id="messages-toggle-btn" title="Messages" aria-label="Open messages">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
            <polyline points="22,6 12,13 2,6"/>
          </svg>
          <span class="unread-badge" id="unread-badge" aria-live="polite"></span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content Area -->
  <main class="app-main" id="main-content" role="main">
    <!-- Profile View -->
    <div class="tab-view active" id="profile-view" role="tabpanel" aria-labelledby="profile-tab">
      <div class="profile-main">
    <!-- Profile Hero Section -->
    <section class="profile-hero" aria-label="Profile information">
      <!-- Background Image -->
      <div class="hero-background" id="hero-background" aria-hidden="true">
        <button class="change-bg-btn" id="change-bg-btn" title="Change background" aria-label="Change background image">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
        </button>
      </div>

      <!-- Profile Card -->
      <div class="profile-card">
        <div class="profile-left">
          <!-- Profile Picture -->
          <div class="profile-picture-wrapper">
            <img src="" alt="Your profile picture" class="profile-picture" id="profile-picture">
            <button class="upload-photo-btn" id="upload-photo-btn" title="Upload photo" aria-label="Upload profile photo">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
        </div>

        <div class="profile-right">
          <div class="profile-name-row">
            <h1 class="profile-name" id="profile-name">Loading...</h1>
            <span class="profile-pronouns" id="profile-pronouns"></span>
            <span class="member-since" id="member-since"></span>
          </div>
          <span class="profile-location" id="profile-location"></span>
          <p class="profile-bio" id="profile-bio"></p>
          <div class="external-links-display" id="external-links-display"></div>

          <!-- Profile Completion Progress -->
          <div class="profile-completion" id="profile-completion" style="display: none;">
            <div class="completion-bar">
              <div class="completion-fill" id="completion-fill"></div>
            </div>
            <span class="completion-text" id="completion-text">Profile 0% complete</span>
          </div>

          <div class="profile-action-buttons">
            <button class="edit-profile-btn" id="edit-profile-btn" aria-label="Edit your profile">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
              Edit Profile
            </button>

            <!-- Share Profile Button -->
            <div class="share-dropdown-container">
              <button class="share-profile-btn" id="share-profile-btn" aria-label="Share your profile" aria-haspopup="true" aria-expanded="false">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <circle cx="18" cy="5" r="3"/>
                  <circle cx="6" cy="12" r="3"/>
                  <circle cx="18" cy="19" r="3"/>
                  <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                  <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                </svg>
                Share
              </button>
              <div class="share-dropdown" id="share-dropdown" role="menu" aria-label="Share options">
                <button class="share-option" data-share="twitter" role="menuitem">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                  </svg>
                  Share on X
                </button>
                <button class="share-option" data-share="facebook" role="menuitem">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                  </svg>
                  Share on Facebook
                </button>
                <button class="share-option" data-share="copy" role="menuitem">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                  </svg>
                  Copy Link
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Category Switcher -->
    <section class="category-switcher-section" id="category-switcher-section" aria-label="Switch collection category">
      <div class="category-tabs" id="category-tabs" role="tablist" aria-label="Collection categories">
        <!-- Dynamically populated with category tabs -->
      </div>
    </section>

    <!-- Collection Summary Card (Multi-Collection Identity) -->
    <section class="collection-summary-section" id="collection-summary-section" style="display: none;" aria-label="Collection categories">
      <div class="collection-summary-card" id="collection-summary-card" role="list" aria-label="Your collection categories">
        <!-- Dynamically populated with collection badges -->
      </div>
    </section>

    <!-- Showcase Section -->
    <section class="showcase-section" aria-labelledby="showcase-heading">
      <div class="section-header">
        <h2 id="showcase-heading">
          <span class="section-icon" aria-hidden="true">‚ú®</span>
          My Showcase
        </h2>
        <button class="add-btn" id="add-to-showcase-btn" aria-label="Add record to showcase">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Record
        </button>
      </div>
      <div class="showcase-grid" id="showcase-grid" role="list" aria-label="Showcase records" aria-live="polite">
        <div class="showcase-empty" id="showcase-empty">
          <div class="empty-icon" aria-hidden="true">üìÄ</div>
          <p>No records in your showcase yet</p>
          <span>Feature your favorite albums here!</span>
        </div>
      </div>
    </section>

    <!-- Collection Section -->
    <section class="collection-section" aria-labelledby="collection-heading">
      <div class="section-header">
        <h2 id="collection-heading">
          <span class="section-icon" aria-hidden="true">üìö</span>
          My Collection
          <span class="collection-count" id="collection-count" aria-label="Total records in collection">0</span>
        </h2>
        <button class="add-btn" id="add-record-btn" aria-label="Add record to collection">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Record
        </button>
      </div>
      <!-- Collection search and filters -->
      <div class="collection-filters" role="search" aria-label="Filter collection">
        <div class="collection-search">
          <input type="text" id="collection-search-input" placeholder="Search your collection..." autocomplete="off" aria-label="Search your collection">
        </div>
        <div class="filter-controls">
          <select id="filter-genre" class="filter-select" aria-label="Filter by genre">
            <option value="">All Genres</option>
          </select>
          <select id="filter-year" class="filter-select" aria-label="Filter by year">
            <option value="">All Years</option>
          </select>
          <select id="filter-sort" class="filter-select" aria-label="Sort collection">
            <option value="recent">Recently Added</option>
            <option value="artist-asc">Artist A-Z</option>
            <option value="artist-desc">Artist Z-A</option>
            <option value="album-asc">Album A-Z</option>
            <option value="album-desc">Album Z-A</option>
            <option value="year-asc">Year (Oldest)</option>
            <option value="year-desc">Year (Newest)</option>
          </select>
        </div>
      </div>
      <!-- Cover fetch progress bar -->
      <div class="cover-progress" id="cover-progress" style="display: none;" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Fetching album covers">
        <div class="cover-progress-info">
          <span id="cover-progress-text">Fetching covers...</span>
          <span id="cover-progress-count" aria-live="polite">0 / 0</span>
          <span id="cover-progress-eta"></span>
        </div>
        <div class="cover-progress-bar">
          <div class="cover-progress-fill" id="cover-progress-fill"></div>
        </div>
      </div>
      <div class="collection-grid" id="collection-grid" role="list" aria-label="Your collection" aria-live="polite">
        <div class="collection-empty" id="collection-empty">
          <div class="empty-icon" aria-hidden="true">üéµ</div>
          <p>Your collection is empty</p>
          <span>Start adding your vinyl records!</span>
        </div>
      </div>
    </section>

    <!-- Wishlist / Currently Seeking Section -->
    <section class="wishlist-section" id="wishlist-section" style="display: none;" aria-labelledby="wishlist-heading">
      <div class="section-header">
        <h2 id="wishlist-heading">
          <span class="section-icon" aria-hidden="true">üéØ</span>
          Currently Seeking
          <span class="wishlist-count" id="wishlist-count" aria-label="Items on wishlist">0</span>
        </h2>
        <button class="add-btn" id="add-wishlist-btn" aria-label="Add item to wishlist">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Wanted Item
        </button>
      </div>
      <div class="wishlist-grid" id="wishlist-grid" role="list" aria-label="Your wishlist">
        <div class="wishlist-empty" id="wishlist-empty">
          <div class="empty-icon" aria-hidden="true">üîç</div>
          <p>No items on your wishlist</p>
          <span>Add items you're looking for!</span>
        </div>
      </div>
    </section>

    <!-- Friends Section -->
    <section class="friends-section" aria-labelledby="friends-heading">
      <div class="section-header">
        <h2 id="friends-heading">
          <span class="section-icon" aria-hidden="true">üë•</span>
          Friends
          <span class="friends-count" id="friends-count" aria-label="Number of friends">0</span>
        </h2>
        <button class="add-btn" id="add-friend-btn" aria-label="Add a friend">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="8.5" cy="7" r="4"/>
            <line x1="20" y1="8" x2="20" y2="14"/>
            <line x1="23" y1="11" x2="17" y2="11"/>
          </svg>
          Add Friend
        </button>
      </div>
      <div class="friends-grid" id="friends-grid" role="list" aria-label="Your friends">
        <div class="friends-empty" id="friends-empty">
          <div class="empty-icon" aria-hidden="true">ü§ù</div>
          <p>No friends yet</p>
          <span>Connect with other collectors!</span>
        </div>
      </div>
    </section>
      </div><!-- end profile-main -->
    </div><!-- end profile-view -->

    <!-- Marketplace View -->
    <div class="tab-view" id="marketplace-view" role="tabpanel" aria-labelledby="marketplace-tab">
      <div class="marketplace-container">
        <!-- Marketplace Header -->
        <div class="marketplace-header">
          <div class="marketplace-tabs">
            <button class="marketplace-tab active" data-section="browse">Browse</button>
            <button class="marketplace-tab" data-section="my-listings">My Listings</button>
            <button class="marketplace-tab" data-section="my-offers">My Offers</button>
            <button class="marketplace-tab" data-section="messages">Messages <span class="marketplace-msg-badge" id="marketplace-msg-badge"></span></button>
          </div>
          <button class="create-listing-btn" id="create-listing-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Create Listing
          </button>
        </div>

        <!-- Browse Section -->
        <div class="marketplace-section active" id="marketplace-browse">
          <div class="marketplace-filters">
            <div class="filter-row">
              <div class="marketplace-search">
                <input type="text" id="marketplace-search-input" placeholder="Search listings..." autocomplete="off" aria-label="Search marketplace">
              </div>
              <select id="filter-category" class="filter-select" aria-label="Filter by category">
                <option value="">All Categories</option>
                <option value="vinyl">Vinyl Records</option>
                <option value="trading-cards">Trading Cards</option>
                <option value="comics">Comics</option>
                <option value="video-games">Video Games</option>
                <option value="sneakers">Sneakers</option>
                <option value="watches">Watches</option>
                <option value="coins">Coins</option>
                <option value="cars">Cars</option>
              </select>
              <select id="filter-condition" class="filter-select" aria-label="Filter by condition">
                <option value="">Any Condition</option>
                <option value="mint">Mint</option>
                <option value="near_mint">Near Mint</option>
                <option value="excellent">Excellent</option>
                <option value="very_good">Very Good</option>
                <option value="good">Good</option>
                <option value="fair">Fair</option>
                <option value="poor">Poor</option>
              </select>
              <select id="filter-type" class="filter-select" aria-label="Filter by type">
                <option value="">All Types</option>
                <option value="sale">For Sale</option>
                <option value="trade">Trade Only</option>
                <option value="both">Sale or Trade</option>
              </select>
            </div>
            <div class="filter-row">
              <div class="price-range">
                <input type="number" id="filter-price-min" placeholder="Min $" min="0" aria-label="Minimum price">
                <span>-</span>
                <input type="number" id="filter-price-max" placeholder="Max $" min="0" aria-label="Maximum price">
              </div>
              <input type="text" id="filter-location" class="location-input" placeholder="Location..." aria-label="Filter by location">
              <select id="filter-sort-listings" class="filter-select" aria-label="Sort listings">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
              </select>
              <button class="btn-apply-filters" id="apply-marketplace-filters">Apply Filters</button>
            </div>
          </div>
          <div class="listings-grid" id="listings-grid">
            <div class="listings-empty" id="listings-empty">
              <div class="empty-icon">üè™</div>
              <p>No listings found</p>
              <span>Be the first to create a listing!</span>
            </div>
          </div>
          <div class="listings-pagination" id="listings-pagination"></div>
        </div>

        <!-- My Listings Section -->
        <div class="marketplace-section" id="marketplace-my-listings">
          <div class="my-listings-tabs">
            <button class="my-listings-tab active" data-status="active">Active</button>
            <button class="my-listings-tab" data-status="sold">Sold</button>
            <button class="my-listings-tab" data-status="expired">Expired</button>
          </div>
          <div class="listings-grid" id="my-listings-grid">
            <div class="listings-empty" id="my-listings-empty">
              <div class="empty-icon">üì¶</div>
              <p>No listings yet</p>
              <span>Create your first listing to start selling!</span>
            </div>
          </div>
        </div>

        <!-- My Offers Section -->
        <div class="marketplace-section" id="marketplace-my-offers">
          <div class="my-offers-tabs">
            <button class="my-offers-tab active" data-type="received">Received</button>
            <button class="my-offers-tab" data-type="sent">Sent</button>
          </div>
          <div class="offers-list" id="offers-list">
            <div class="offers-empty" id="offers-empty">
              <div class="empty-icon">üì®</div>
              <p>No offers yet</p>
              <span>Offers you receive or send will appear here</span>
            </div>
          </div>
        </div>

        <!-- Messages Section -->
        <div class="marketplace-section" id="marketplace-messages">
          <div class="marketplace-messages-container">
            <!-- Conversations List -->
            <div class="conversations-list" id="conversations-list">
              <div class="conversations-empty" id="conversations-empty">
                <div class="empty-icon">üí¨</div>
                <p>No conversations yet</p>
                <span>Message sellers about listings to start a conversation</span>
              </div>
            </div>
            <!-- Chat View -->
            <div class="marketplace-chat" id="marketplace-chat" style="display: none;">
              <div class="chat-header">
                <button class="chat-back-btn" id="chat-back-btn">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                  </svg>
                </button>
                <img src="" alt="" class="chat-avatar" id="chat-other-avatar">
                <div class="chat-info">
                  <span class="chat-name" id="chat-other-name"></span>
                  <span class="chat-listing" id="chat-listing-title"></span>
                </div>
              </div>
              <div class="chat-messages" id="chat-messages"></div>
              <div class="chat-offer-bar" id="chat-offer-bar"></div>
              <div class="chat-input">
                <input type="text" id="chat-message-input" placeholder="Type a message..." maxlength="2000">
                <button class="chat-send-btn" id="chat-send-btn">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div><!-- end marketplace-view -->

    <!-- Forums View -->
    <div class="tab-view" id="forums-view" role="tabpanel" aria-labelledby="forums-tab">
      <div class="forums-container">
        <!-- Forums Header -->
        <div class="forums-header" role="toolbar" aria-label="Forum controls">
          <div class="feed-tabs" role="tablist" aria-label="Sort posts">
            <button class="feed-tab active" data-sort="hot" role="tab" aria-selected="true">Hot</button>
            <button class="feed-tab" data-sort="new" role="tab" aria-selected="false">New</button>
            <button class="feed-tab" data-sort="top" role="tab" aria-selected="false">Top</button>
            <button class="feed-tab" data-sort="saved" role="tab" aria-selected="false">Saved</button>
          </div>
          <select class="feed-filter" id="feed-filter" aria-label="Filter posts by type">
            <option value="all">All Posts</option>
            <option value="discussion">Discussions</option>
            <option value="showcase">Showcases</option>
            <option value="wtt_wts">Trading</option>
            <option value="question">Questions</option>
          </select>
          <button class="create-post-btn" id="create-post-btn" aria-label="Create new post">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            New Post
          </button>
        </div>

        <div class="forums-layout">
          <!-- Sidebar -->
          <aside class="forums-sidebar" role="complementary" aria-label="Forum groups">
            <div class="sidebar-section">
              <h3 id="my-groups-heading">My Groups</h3>
              <div class="my-groups-list" id="my-groups-list" role="list" aria-labelledby="my-groups-heading">
                <div class="groups-empty">Join groups to see them here</div>
              </div>
              <button class="discover-btn" id="discover-groups-btn" aria-label="Discover new groups">+ Discover Groups</button>
            </div>

            <!-- Trending Section -->
            <div class="sidebar-section trending-section">
              <h3 id="trending-heading">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                  <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                  <polyline points="17 6 23 6 23 12"/>
                </svg>
                Trending
              </h3>
              <div class="trending-posts-list" id="trending-posts-list" role="list" aria-labelledby="trending-heading">
                <div class="trending-loading">Loading...</div>
              </div>
            </div>

            <!-- Featured Collectors Section -->
            <div class="sidebar-section featured-collectors-section">
              <h3 id="featured-collectors-heading">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Active Collectors
              </h3>
              <div class="featured-collectors-list" id="featured-collectors-list" role="list" aria-labelledby="featured-collectors-heading">
                <div class="trending-loading">Loading...</div>
              </div>
            </div>
          </aside>

          <!-- Feed Content -->
          <div class="feed-content" id="feed-content" role="feed" aria-label="Forum posts" aria-live="polite">
            <div class="feed-empty" id="feed-empty">
              <div class="empty-icon" aria-hidden="true">üì∞</div>
              <p>No posts yet</p>
              <span>Join some groups to see posts in your feed!</span>
            </div>
          </div>
        </div>
      </div>
    </div><!-- end forums-view -->
  </main>

  <!-- Footer -->
  <footer class="site-footer" role="contentinfo">
    <div class="footer-content">
      <span class="footer-copyright">&copy; 2025 Niche Collector Connector</span>
      <nav class="footer-links" aria-label="Footer navigation">
        <a href="terms.html">Terms of Service</a>
        <a href="privacy.html">Privacy Policy</a>
      </nav>
    </div>
  </footer>

  <!-- AI Assistant Toggle -->
  <button class="ai-toggle-btn" id="ai-toggle-btn" title="AI Assistant" aria-label="Open AI assistant">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    </svg>
  </button>

  <!-- AI Sidebar -->
  <aside class="ai-sidebar" id="ai-sidebar" role="complementary" aria-labelledby="ai-sidebar-title" aria-hidden="true">
    <div class="ai-header">
      <div class="ai-title">
        <span class="ai-icon" aria-hidden="true">ü§ñ</span>
        <h3 id="ai-sidebar-title">AI Assistant</h3>
      </div>
      <button class="ai-close" id="ai-close-btn" aria-label="Close AI assistant">&times;</button>
    </div>
    <div class="ai-chat" id="ai-chat-container" role="log" aria-live="polite" aria-label="Chat messages">
      <div class="ai-welcome">
        <div class="welcome-icon" aria-hidden="true">üëã</div>
        <h4>Hey there!</h4>
        <p>I can help you with:</p>
        <ul>
          <li>Writing your bio</li>
          <li>Adding records to your collection</li>
          <li>Finding albums on Discogs</li>
          <li>Choosing what to showcase</li>
        </ul>
      </div>
    </div>
    <form class="ai-form" id="ai-input-form" aria-label="Send message to AI">
      <input type="file" id="ai-file-input" accept=".txt" style="display: none;">
      <button type="button" id="ai-upload-btn" class="ai-upload-btn" title="Upload .txt file with album list" aria-label="Upload album list file">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
      </button>
      <input type="text" id="ai-input" placeholder="Type a message..." autocomplete="off" aria-label="Chat with AI assistant">
      <button type="submit" id="ai-send-btn" aria-label="Send message">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </form>
  </aside>

  <!-- Overlay for sidebar -->
  <div class="sidebar-overlay" id="sidebar-overlay" aria-hidden="true"></div>

  <!-- Messages Sidebar -->
  <aside class="messages-sidebar" id="messages-sidebar" role="complementary" aria-labelledby="messages-sidebar-title" aria-hidden="true">
    <div class="messages-header">
      <div class="messages-title">
        <span class="messages-icon" aria-hidden="true">üí¨</span>
        <h3 id="messages-sidebar-title">Messages</h3>
      </div>
      <button class="messages-close" id="messages-close-btn" aria-label="Close messages">&times;</button>
    </div>
    <!-- Friends List View (for starting conversations) -->
    <div class="friends-list-view" id="friends-list-view">
      <div class="friends-message-list" id="friends-message-list" role="list" aria-label="Friends to message">
        <div class="friends-list-empty">
          <div class="empty-icon" aria-hidden="true">üë•</div>
          <p>No friends yet</p>
          <span>Add friends to start messaging!</span>
        </div>
      </div>
    </div>
    <!-- Individual Conversation View -->
    <div class="conversation-view" id="conversation-view" style="display:none">
      <div class="conversation-header">
        <button class="back-btn" id="conversation-back-btn" aria-label="Back to friends list" onclick="ProfileMessages.backToConversations()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
        </button>
        <img class="conversation-avatar" id="conversation-avatar" src="" alt="Contact avatar">
        <span class="conversation-with" id="conversation-with"></span>
      </div>
      <div class="messages-list" id="messages-list" role="log" aria-live="polite" aria-label="Conversation messages"></div>
      <form class="message-form" id="message-form" aria-label="Send a message">
        <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" maxlength="1000" aria-label="Type a message">
        <button type="submit" class="send-btn" aria-label="Send message">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </form>
    </div>
  </aside>

  <!-- Add Friend Modal -->
  <div class="modal" id="add-friend-modal" role="dialog" aria-modal="true" aria-labelledby="add-friend-modal-title" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="add-friend-modal-title">Add Friend</h3>
        <button class="modal-close" id="add-friend-close" aria-label="Close add friend dialog">&times;</button>
      </div>
      <div class="add-friend-content">
        <p class="modal-subtitle" id="add-friend-description">Enter their exact profile name (case-sensitive)</p>
        <div class="form-group">
          <input type="text" id="friend-name-input" placeholder="Profile name" maxlength="100" aria-label="Friend's profile name" aria-describedby="add-friend-description">
        </div>
        <div class="friend-search-result" id="friend-search-result" role="status" aria-live="polite"></div>
        <div class="form-actions">
          <button type="button" class="btn-cancel" id="add-friend-cancel">Cancel</button>
          <button type="button" class="btn-save" id="add-friend-confirm" disabled aria-disabled="true">Add Friend</button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Profile Modal -->
  <div class="modal" id="view-profile-modal" role="dialog" aria-modal="true" aria-labelledby="view-profile-modal-title" aria-hidden="true">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 id="view-profile-modal-title">Profile</h3>
        <button class="modal-close" id="view-profile-close" aria-label="Close profile dialog">&times;</button>
      </div>
      <div class="view-profile-content" id="view-profile-content">
        <div class="view-profile-header">
          <div class="view-profile-bg" id="view-profile-bg" aria-hidden="true"></div>
          <img class="view-profile-picture" id="view-profile-picture" src="" alt="User profile picture">
        </div>
        <div class="view-profile-info">
          <div class="view-profile-name-row">
            <h2 id="view-profile-name"></h2>
            <span class="view-profile-pronouns" id="view-profile-pronouns"></span>
          </div>
          <p class="view-profile-bio" id="view-profile-bio"></p>
          <div class="view-profile-stats">
            <span id="view-profile-collection-count">0 records</span>
          </div>
          <div class="view-profile-actions" id="view-profile-actions">
            <button class="btn-message" id="view-profile-message" aria-label="Send message to this user">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
              Message
            </button>
            <button class="btn-unfollow" id="view-profile-unfollow" aria-label="Unfollow this user">Unfollow</button>
            <button class="btn-report" id="view-profile-report" aria-label="Report this user" title="Report this profile">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
                <line x1="4" y1="22" x2="4" y2="15"/>
              </svg>
              Report
            </button>
          </div>
        </div>
        <div class="view-profile-showcase">
          <h3 id="view-showcase-title">Showcase</h3>
          <div class="view-showcase-grid" id="view-showcase-grid" role="list" aria-label="User's showcase"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div class="modal" id="edit-profile-modal" role="dialog" aria-modal="true" aria-labelledby="edit-profile-modal-title" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="edit-profile-modal-title">Edit Profile</h3>
        <button class="modal-close" id="edit-profile-close" aria-label="Close edit profile dialog">&times;</button>
      </div>
      <form id="edit-profile-form">
        <div class="form-group">
          <label for="edit-name">Display Name</label>
          <input type="text" id="edit-name" maxlength="100" placeholder="Your name">
        </div>
        <div class="form-group">
          <label for="edit-pronouns">Pronouns</label>
          <input type="text" id="edit-pronouns" placeholder="e.g., they/them, she/her, he/him" maxlength="50">
        </div>
        <div class="form-group">
          <label for="edit-bio">Bio</label>
          <textarea id="edit-bio" rows="4" maxlength="500" placeholder="Tell us about yourself and your vinyl journey..." aria-describedby="bio-char-count-label"></textarea>
          <span class="char-count"><span id="bio-char-count">0</span>/500</span>
        </div>
        <div class="form-group">
          <label for="edit-location">Location</label>
          <input type="text" id="edit-location" maxlength="100" placeholder="City, State/Country">
        </div>

        <!-- Social Links Section -->
        <div class="social-links-section">
          <div class="social-links-header">
            <h4>Social Links</h4>
            <button type="button" class="add-social-btn" id="add-social-btn" title="Add social link" aria-label="Add social link">+</button>
          </div>
          <div class="social-links-list" id="social-links-list">
            <!-- Dynamic social links will be added here -->
          </div>
          <div class="social-picker" id="social-picker" style="display: none;">
            <div class="social-picker-options" id="social-picker-options">
              <!-- Options populated by JS -->
            </div>
          </div>
        </div>

        <!-- Featured Category Section -->
        <div class="featured-category-section">
          <h4 style="color: #1db954; margin: 16px 0 12px; font-size: 0.9rem;">Profile Preview</h4>
          <div class="form-group">
            <label for="featured-category">Featured Showcase</label>
            <select id="featured-category" class="privacy-select">
              <option value="0">All Categories</option>
              <!-- Categories populated by JS -->
            </select>
            <small style="color: #888; margin-top: 4px; display: block;">Choose which collection appears on your profile preview</small>
          </div>
        </div>

        <!-- Privacy Settings Section -->
        <div class="privacy-section">
          <h4 style="color: #1db954; margin: 16px 0 12px; font-size: 0.9rem;">Privacy Settings</h4>
          <div class="toggle-group">
            <label class="toggle-label">
              <span>Profile Visibility</span>
              <select id="privacy-visibility" class="privacy-select">
                <option value="public">Public</option>
                <option value="friends_only">Friends Only</option>
                <option value="private">Private</option>
              </select>
            </label>
          </div>
          <div class="toggle-group">
            <label class="toggle-label">
              <span>Show Collection</span>
              <input type="checkbox" id="privacy-collection" checked class="toggle-checkbox">
              <span class="toggle-switch"></span>
            </label>
          </div>
          <div class="toggle-group">
            <label class="toggle-label">
              <span>Show Showcase</span>
              <input type="checkbox" id="privacy-showcase" checked class="toggle-checkbox">
              <span class="toggle-switch"></span>
            </label>
          </div>
          <div class="toggle-group">
            <label class="toggle-label">
              <span>Searchable by Friends</span>
              <input type="checkbox" id="privacy-searchable" checked class="toggle-checkbox">
              <span class="toggle-switch"></span>
            </label>
          </div>
        </div>

        <!-- Email Notification Settings Section -->
        <div class="notifications-section">
          <h4 style="color: #1db954; margin: 16px 0 12px; font-size: 0.9rem;">Email Notifications</h4>
          <div class="toggle-group">
            <label class="toggle-label">
              <span>Friend Requests</span>
              <input type="checkbox" id="notify-friend-requests" checked class="toggle-checkbox">
              <span class="toggle-switch"></span>
            </label>
          </div>
          <div class="toggle-group">
            <label class="toggle-label">
              <span>Messages</span>
              <input type="checkbox" id="notify-messages" checked class="toggle-checkbox">
              <span class="toggle-switch"></span>
            </label>
          </div>
          <div class="toggle-group">
            <label class="toggle-label">
              <span>Forum Replies</span>
              <input type="checkbox" id="notify-forum-replies" checked class="toggle-checkbox">
              <span class="toggle-switch"></span>
            </label>
          </div>
          <div class="toggle-group">
            <label class="toggle-label">
              <span>Marketplace Offers</span>
              <input type="checkbox" id="notify-offers" checked class="toggle-checkbox">
              <span class="toggle-switch"></span>
            </label>
          </div>
          <div class="toggle-group">
            <label class="toggle-label">
              <span>Sales & Transactions</span>
              <input type="checkbox" id="notify-sales" checked class="toggle-checkbox">
              <span class="toggle-switch"></span>
            </label>
          </div>
        </div>

        <!-- Blocked Users Section -->
        <div class="blocked-users-section">
          <h4 style="color: #1db954; margin: 16px 0 12px; font-size: 0.9rem;">Blocked Users</h4>
          <div id="blocked-users-list" class="blocked-users-list">
            <p class="blocked-users-empty">Loading blocked users...</p>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancel" id="edit-profile-cancel">Cancel</button>
          <button type="submit" class="btn-save">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Wishlist Item Modal -->
  <div class="modal" id="add-wishlist-modal" role="dialog" aria-modal="true" aria-labelledby="add-wishlist-modal-title" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="add-wishlist-modal-title">Add Wanted Item</h3>
        <button class="modal-close" id="add-wishlist-close" aria-label="Close add wishlist dialog">&times;</button>
      </div>
      <form id="add-wishlist-form">
        <div class="form-group">
          <label for="wishlist-title">Item Title *</label>
          <input type="text" id="wishlist-title" required placeholder="Album name, card name, etc." maxlength="200">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="wishlist-artist">Artist / Brand</label>
            <input type="text" id="wishlist-artist" placeholder="Artist or manufacturer" maxlength="200">
          </div>
          <div class="form-group">
            <label for="wishlist-year">Year</label>
            <input type="number" id="wishlist-year" min="1900" max="2030" placeholder="Release year">
          </div>
        </div>
        <div class="form-group">
          <label for="wishlist-description">Description</label>
          <textarea id="wishlist-description" rows="2" maxlength="500" placeholder="Additional details, specific pressing, etc."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="wishlist-condition">Condition Wanted</label>
            <select id="wishlist-condition">
              <option value="">Any Condition</option>
              <option value="Mint">Mint (M)</option>
              <option value="Near Mint">Near Mint (NM)</option>
              <option value="Very Good Plus">Very Good Plus (VG+)</option>
              <option value="Very Good">Very Good (VG)</option>
              <option value="Good Plus">Good Plus (G+)</option>
              <option value="Good">Good (G)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="wishlist-max-price">Max Price ($)</label>
            <input type="number" id="wishlist-max-price" min="0" step="0.01" placeholder="0.00">
          </div>
        </div>
        <div class="form-group">
          <label for="wishlist-priority">Priority</label>
          <select id="wishlist-priority">
            <option value="0">Low Priority</option>
            <option value="1">Medium Priority</option>
            <option value="2">High Priority - Grail!</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-cancel" id="add-wishlist-cancel">Cancel</button>
          <button type="submit" class="btn-save">Add to Wishlist</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Record Modal -->
  <div class="modal" id="add-record-modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3>Add Record</h3>
        <button class="modal-close" id="add-record-close">&times;</button>
      </div>
      <div class="modal-tabs">
        <button class="tab-btn active" data-tab="manual">Manual Entry</button>
        <button class="tab-btn" data-tab="search">Search Discogs</button>
      </div>
      <div class="tab-content active" id="tab-manual">
        <form id="manual-add-form">
          <div class="form-row">
            <div class="form-group">
              <label for="manual-artist" id="manual-artist-label">Artist *</label>
              <input type="text" id="manual-artist" required placeholder="Artist name">
            </div>
            <div class="form-group">
              <label for="manual-album" id="manual-album-label">Album *</label>
              <input type="text" id="manual-album" required placeholder="Album title">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" id="manual-year-group">
              <label for="manual-year" id="manual-year-label">Year</label>
              <input type="text" id="manual-year" placeholder="Release year">
            </div>
            <div class="form-group">
              <label for="manual-cover">Cover Image URL</label>
              <input type="url" id="manual-cover" placeholder="https://...">
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-cancel" id="manual-add-cancel">Cancel</button>
            <button type="submit" class="btn-save">Add to Collection</button>
          </div>
        </form>
      </div>
      <div class="tab-content" id="tab-search">
        <form id="discogs-search-form" class="search-form">
          <input type="text" id="discogs-query" placeholder="Search for artist or album...">
          <button type="submit" class="btn-search">Search</button>
        </form>
        <div class="search-results" id="search-results"></div>
      </div>
    </div>
  </div>

  <!-- Showcase Modal -->
  <div class="modal" id="showcase-modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3>Add to Showcase</h3>
        <button class="modal-close" id="showcase-modal-close">&times;</button>
      </div>
      <p class="modal-subtitle">Select a record to feature on your profile</p>
      <div class="showcase-select-grid" id="showcase-select-grid"></div>
    </div>
  </div>

  <!-- Image Cropper Modal -->
  <div class="modal" id="cropper-modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 id="cropper-title">Adjust Image</h3>
        <button class="modal-close" id="cropper-modal-close">&times;</button>
      </div>
      <div class="cropper-container">
        <img id="cropper-image" src="" alt="Crop preview">
      </div>
      <div class="cropper-controls">
        <button type="button" class="btn-icon" id="crop-rotate-left" title="Rotate left">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38"/>
          </svg>
        </button>
        <button type="button" class="btn-icon" id="crop-rotate-right" title="Rotate right">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38"/>
          </svg>
        </button>
        <button type="button" class="btn-icon" id="crop-zoom-in" title="Zoom in">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
            <line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/>
          </svg>
        </button>
        <button type="button" class="btn-icon" id="crop-zoom-out" title="Zoom out">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
            <line x1="8" y1="11" x2="14" y2="11"/>
          </svg>
        </button>
        <button type="button" class="btn-icon" id="crop-reset" title="Reset">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
            <path d="M3 3v5h5"/>
          </svg>
        </button>
      </div>
      <div class="form-actions">
        <button type="button" class="btn-cancel" id="cropper-cancel">Cancel</button>
        <button type="button" class="btn-save" id="cropper-save">
          <span class="btn-text">Save Image</span>
          <span class="btn-loading" style="display:none;">Uploading...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Interest Onboarding Modal -->
  <div class="modal" id="onboarding-modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 id="onboarding-title">Welcome to NCC!</h3>
      </div>
      <div class="onboarding-content">
        <p class="onboarding-subtitle">What do you collect?</p>
        <div class="categories-grid" id="categories-grid"></div>
        <div class="onboarding-subgroups" id="onboarding-subgroups" style="display:none">
          <p class="onboarding-subtitle">Select your interests</p>
          <div class="subgroups-grid" id="subgroups-grid"></div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-back" id="onboarding-back" style="display:none">Back</button>
          <button type="button" class="btn-save" id="onboarding-continue" disabled>Continue</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Post Modal -->
  <div class="modal" id="create-post-modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3>Create Post</h3>
        <button class="modal-close" id="create-post-close">&times;</button>
      </div>
      <form id="create-post-form">
        <div class="form-row">
          <div class="form-group">
            <label for="post-category">Category *</label>
            <select id="post-category" required>
              <option value="">Select category...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="post-group">Group (optional)</label>
            <select id="post-group">
              <option value="">No specific group</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="post-type">Post Type</label>
          <select id="post-type">
            <option value="discussion">Discussion</option>
            <option value="showcase">Showcase</option>
            <option value="wtt_wts">Want to Trade / Sell</option>
            <option value="question">Question</option>
          </select>
        </div>
        <div class="form-group">
          <label for="post-title">Title *</label>
          <input type="text" id="post-title" required maxlength="200" placeholder="What's on your mind?">
        </div>
        <div class="form-group">
          <label for="post-body">Content *</label>
          <textarea id="post-body" required rows="6" maxlength="5000" placeholder="Share your thoughts..."></textarea>
        </div>
        <div class="form-group">
          <label>Images (optional)</label>
          <div class="image-upload-area" id="post-image-upload">
            <input type="file" id="post-image-input" accept="image/*" multiple style="display: none;">
            <button type="button" class="btn-upload" onclick="document.getElementById('post-image-input').click()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
              Add Images
            </button>
            <div class="image-previews" id="post-image-previews"></div>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-cancel" id="create-post-cancel">Cancel</button>
          <button type="submit" class="btn-save">Post</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Post Detail Modal -->
  <div class="modal" id="post-detail-modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 id="post-detail-title">Post</h3>
        <button class="modal-close" id="post-detail-close">&times;</button>
      </div>
      <div class="post-detail-content" id="post-detail-content"></div>
    </div>
  </div>

  <!-- Discover Groups Modal -->
  <div class="modal" id="discover-modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3>Discover Groups</h3>
        <button class="modal-close" id="discover-close">&times;</button>
      </div>
      <div class="discover-content">
        <div class="discover-categories" id="discover-categories"></div>
      </div>
    </div>
  </div>

  <!-- Report Content Modal -->
  <div class="modal" id="report-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Report Content</h3>
        <button class="modal-close" id="report-close">&times;</button>
      </div>
      <form id="report-form" class="modal-form">
        <input type="hidden" id="report-content-type" name="content_type">
        <input type="hidden" id="report-content-id" name="content_id">

        <div class="form-group">
          <label for="report-reason">Reason for report</label>
          <select id="report-reason" name="reason" required>
            <option value="">Select a reason...</option>
            <option value="spam">Spam or misleading</option>
            <option value="harassment">Harassment or bullying</option>
            <option value="inappropriate">Inappropriate content</option>
            <option value="scam">Scam or fraud</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label for="report-details">Additional details (optional)</label>
          <textarea id="report-details" name="details" rows="4" maxlength="1000" placeholder="Provide any additional context that might help our team review this report..."></textarea>
          <span class="char-count"><span id="report-details-count">0</span>/1000</span>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" id="report-cancel">Cancel</button>
          <button type="submit" class="btn-primary btn-danger">Submit Report</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Category Template Switcher (in profile view header) -->


  <!-- Create Listing Modal -->
  <div class="modal" id="create-listing-modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3>Create Listing</h3>
        <button class="modal-close" id="create-listing-close">&times;</button>
      </div>
      <div class="modal-tabs">
        <button class="tab-btn active" data-tab="listing-collection">From Collection</button>
        <button class="tab-btn" data-tab="listing-manual">Manual Entry</button>
      </div>
      <div class="tab-content active" id="tab-listing-collection">
        <p class="modal-subtitle">Select an item from your collection to list</p>
        <div class="listing-collection-grid" id="listing-collection-grid">
          <div class="listings-empty">
            <div class="empty-icon">üì¶</div>
            <p>No items in your collection</p>
            <span>Add items to your collection first</span>
          </div>
        </div>
      </div>
      <div class="tab-content" id="tab-listing-manual">
        <form id="create-listing-form">
          <div class="form-group">
            <label for="listing-title">Title *</label>
            <input type="text" id="listing-title" required maxlength="200" placeholder="What are you selling?">
          </div>
          <div class="form-group">
            <label for="listing-description">Description *</label>
            <textarea id="listing-description" required rows="4" maxlength="2000" placeholder="Describe the item, condition details, any flaws..."></textarea>
          </div>
          <div class="form-group">
            <label for="listing-category">Category *</label>
            <select id="listing-category" required>
              <option value="">Select category...</option>
              <option value="vinyl">Vinyl Records</option>
              <option value="trading-cards">Trading Cards</option>
              <option value="comics">Comics</option>
              <option value="video-games">Video Games</option>
              <option value="sneakers">Sneakers</option>
              <option value="watches">Watches</option>
              <option value="coins">Coins</option>
              <option value="cars">Cars</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="listing-condition">Condition *</label>
              <select id="listing-condition" required>
                <option value="">Select condition...</option>
                <option value="mint">Mint</option>
                <option value="near_mint">Near Mint</option>
                <option value="excellent">Excellent</option>
                <option value="very_good">Very Good</option>
                <option value="good">Good</option>
                <option value="fair">Fair</option>
                <option value="poor">Poor</option>
              </select>
            </div>
            <div class="form-group">
              <label for="listing-type">Listing Type *</label>
              <select id="listing-type" required>
                <option value="sale">For Sale</option>
                <option value="trade">Trade Only</option>
                <option value="both">Sale or Trade</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="listing-price">Price ($)</label>
              <input type="number" id="listing-price" min="0" step="0.01" placeholder="0.00">
              <small class="form-hint">Leave empty for trade-only listings</small>
            </div>
            <div class="form-group">
              <label for="listing-shipping">Shipping</label>
              <select id="listing-shipping">
                <option value="local">Local Pickup Only</option>
                <option value="shipping">Shipping Available</option>
                <option value="both">Pickup or Shipping</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="listing-city">City</label>
              <input type="text" id="listing-city" maxlength="100" placeholder="City">
            </div>
            <div class="form-group">
              <label for="listing-state">State/Region</label>
              <input type="text" id="listing-state" maxlength="100" placeholder="State or region">
            </div>
          </div>
          <div class="form-group">
            <label>Photos</label>
            <div class="listing-photos-upload" id="listing-photos-upload">
              <input type="file" id="listing-photos-input" accept="image/*" multiple style="display: none;">
              <button type="button" class="btn-upload" onclick="document.getElementById('listing-photos-input').click()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <circle cx="8.5" cy="8.5" r="1.5"></circle>
                  <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                Add Photos (up to 6)
              </button>
              <div class="listing-photos-preview" id="listing-photos-preview"></div>
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-cancel" id="create-listing-cancel">Cancel</button>
            <button type="submit" class="btn-save">Create Listing</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Listing Detail Modal -->
  <div class="modal" id="listing-detail-modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 id="listing-detail-title">Listing Details</h3>
        <button class="modal-close" id="listing-detail-close">&times;</button>
      </div>
      <div class="listing-detail-content" id="listing-detail-content">
        <div class="listing-detail-gallery" id="listing-detail-gallery"></div>
        <div class="listing-detail-info">
          <h2 id="listing-detail-name"></h2>
          <div class="listing-detail-meta">
            <span class="listing-price" id="listing-detail-price"></span>
            <span class="listing-condition" id="listing-detail-condition"></span>
            <span class="listing-type-badge" id="listing-detail-type"></span>
          </div>
          <p class="listing-description" id="listing-detail-description"></p>
          <div class="listing-detail-location" id="listing-detail-location"></div>
          <div class="listing-seller" id="listing-detail-seller">
            <img src="" alt="Seller" class="seller-avatar" id="seller-avatar">
            <div class="seller-info">
              <span class="seller-name" id="seller-name"></span>
              <span class="seller-rating" id="seller-rating"></span>
            </div>
          </div>
          <div class="listing-detail-actions" id="listing-detail-actions">
            <button class="btn-make-offer" id="btn-make-offer">Make Offer</button>
            <button class="btn-message-seller" id="btn-message-seller">Message Seller</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Make Offer Modal -->
  <div class="modal" id="make-offer-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Make an Offer</h3>
        <button class="modal-close" id="make-offer-close">&times;</button>
      </div>
      <div class="offer-listing-preview" id="offer-listing-preview"></div>
      <form id="make-offer-form">
        <div class="offer-type-selector">
          <label class="offer-type-option">
            <input type="radio" name="offer-type" value="cash" checked>
            <span>Cash Offer</span>
          </label>
          <label class="offer-type-option">
            <input type="radio" name="offer-type" value="trade">
            <span>Trade</span>
          </label>
          <label class="offer-type-option">
            <input type="radio" name="offer-type" value="both">
            <span>Cash + Trade</span>
          </label>
        </div>
        <div class="form-group offer-cash-section">
          <label for="offer-amount">Your Offer ($)</label>
          <input type="number" id="offer-amount" min="0" step="0.01" placeholder="0.00">
        </div>
        <div class="form-group offer-trade-section" style="display: none;">
          <label>Items to Trade</label>
          <div class="offer-trade-items" id="offer-trade-items">
            <button type="button" class="btn-add-trade-item" id="btn-add-trade-item">+ Add from Collection</button>
          </div>
        </div>
        <div class="form-group">
          <label for="offer-message">Message to Seller (optional)</label>
          <textarea id="offer-message" rows="3" maxlength="500" placeholder="Introduce yourself or add any details..."></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-cancel" id="make-offer-cancel">Cancel</button>
          <button type="submit" class="btn-save">Send Offer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Offer Detail Modal (for managing received offers) -->
  <div class="modal" id="offer-detail-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Offer Details</h3>
        <button class="modal-close" id="offer-detail-close">&times;</button>
      </div>
      <div class="offer-detail-content" id="offer-detail-content">
        <div class="offer-from-section" id="offer-from-section"></div>
        <div class="offer-for-section" id="offer-for-section"></div>
        <div class="offer-amount-section" id="offer-amount-section"></div>
        <div class="offer-trade-section" id="offer-trade-section"></div>
        <div class="offer-message-section" id="offer-message-section"></div>
        <div class="offer-actions" id="offer-actions">
          <button class="btn-accept-offer" id="btn-accept-offer">Accept</button>
          <button class="btn-counter-offer" id="btn-counter-offer">Counter</button>
          <button class="btn-reject-offer" id="btn-reject-offer">Decline</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Counter Offer Modal -->
  <div class="modal" id="counter-offer-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Counter Offer</h3>
        <button class="modal-close" id="counter-offer-close">&times;</button>
      </div>
      <form id="counter-offer-form">
        <p class="modal-subtitle" id="counter-original-amount"></p>
        <div class="form-group">
          <label for="counter-amount">Your Counter Offer ($)</label>
          <input type="number" id="counter-amount" min="0" step="0.01" placeholder="0.00">
        </div>
        <div class="form-group">
          <label for="counter-message">Message (optional)</label>
          <textarea id="counter-message" rows="3" maxlength="500" placeholder="Explain your counter offer..."></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-cancel" id="counter-offer-cancel">Cancel</button>
          <button type="submit" class="btn-save">Send Counter</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Complete Transaction Modal -->
  <div class="modal" id="complete-transaction-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Complete Transaction</h3>
        <button class="modal-close" id="complete-transaction-close">&times;</button>
      </div>
      <div class="transaction-summary" id="transaction-summary"></div>
      <form id="complete-transaction-form">
        <div class="form-group">
          <label for="transaction-rating">Rate this Transaction</label>
          <div class="star-rating" id="transaction-rating">
            <button type="button" class="star" data-rating="1">‚òÖ</button>
            <button type="button" class="star" data-rating="2">‚òÖ</button>
            <button type="button" class="star" data-rating="3">‚òÖ</button>
            <button type="button" class="star" data-rating="4">‚òÖ</button>
            <button type="button" class="star" data-rating="5">‚òÖ</button>
          </div>
          <input type="hidden" id="rating-value" value="0">
        </div>
        <div class="form-group">
          <label for="transaction-feedback">Feedback (optional)</label>
          <textarea id="transaction-feedback" rows="3" maxlength="500" placeholder="Share your experience..."></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-cancel" id="complete-transaction-cancel">Skip for Now</button>
          <button type="submit" class="btn-save">Submit & Complete</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Select Trade Items Modal -->
  <div class="modal" id="select-trade-items-modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3>Select Items to Trade</h3>
        <button class="modal-close" id="select-trade-items-close">&times;</button>
      </div>
      <p class="modal-subtitle">Choose items from your collection to offer in trade</p>
      <div class="trade-items-grid" id="trade-items-grid"></div>
      <div class="form-actions">
        <button type="button" class="btn-cancel" id="select-trade-items-cancel">Cancel</button>
        <button type="button" class="btn-save" id="select-trade-items-confirm">Add Selected</button>
      </div>
    </div>
  </div>

  <!-- Hidden file input for photo upload -->
  <input type="file" id="photo-upload-input" accept="image/*" style="display:none">
  <input type="file" id="bg-upload-input" accept="image/*" style="display:none">

  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/templates/index.js"></script>
  <script src="js/interests.js"></script>
  <script src="js/forums.js"></script>
  <!-- Profile modules (loaded in dependency order before profile.js) -->
  <script src="js/profile-core.js"></script>
  <script src="js/profile-ui.js"></script>
  <script src="js/profile-collection.js"></script>
  <script src="js/profile-showcase.js"></script>
  <script src="js/profile-friends.js"></script>
  <script src="js/profile-messages.js"></script>
  <script src="js/profile-chat.js"></script>
  <script src="js/profile-modals.js"></script>
  <!-- Legacy module components (still used for search/marketplace) -->
  <script src="js/modules/search.js"></script>
  <script src="js/modules/marketplace.js"></script>
  <!-- Main profile entry point (combines all modules) -->
  <script src="js/profile.js"></script>

  <script>
    // Force service worker update and clear old caches
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(registrations => {
        registrations.forEach(registration => {
          registration.update();
        });
      });
      // Clear old caches
      if ('caches' in window) {
        caches.keys().then(names => {
          names.forEach(name => {
            if (!name.includes('v65')) {
              console.log('[SW] Deleting old cache:', name);
              caches.delete(name);
            }
          });
        });
      }
      navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW error:', err));
    }
  </script>
</body>
</html>
